<!DOCTYPE html>
<html lang="ru"><head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Table to CSV</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/exceljs@4.3.0/dist/exceljs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <!-- –ö–æ–Ω—Ñ–∏–≥, –∫–æ—Ç–æ—Ä—ã–π –≤—à–∏–≤–∞–µ—Ç—Å—è –≤ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å" -->
  <script id="userConfig" type="application/json">{
  "columnTemplates": [
    "–¶–µ–Ω–∞ –ë–ù",
    "–¶–µ–Ω–∞ –ù–ê–õ",
    "–¶–µ–Ω–∞ –ë–ù%",
    "–¶–µ–Ω–∞ –ù–ê–õ%",
    "–¶–µ–Ω–∞",
    "–®—Ç—Ä–∏—Ö–∫–æ–¥",
    "–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ",
    "–û—Å—Ç–∞—Ç–æ–∫"
  ],
  "columnSynonyms": {
    "–®—Ç—Ä–∏—Ö–∫–æ–¥": [
      "—à—Ç—Ä–∏—Ö–∫–æ–¥ —à—Ç—É–∫–∞",
      "—à—Ç—Ä–∏—Ö-–∫–æ–¥",
      "—à—Ç—Ä–∏—Ö–∫–æ–¥",
      "—à—Ç—Ä–∏—Ö–∫–æ–¥ –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã"
    ],
    "–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ": [
      "–Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞",
      "–Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–≤",
      "–Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞",
      "–Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ"
    ],
    "–û—Å—Ç–∞—Ç–æ–∫": [
      "—Å–≤–æ–±–æ–¥–Ω—ã–π",
      "—Å–≤–æ–±–æ–¥–Ω—ã–π –æ—Å—Ç–∞—Ç–æ–∫"
    ],
    "–¶–µ–Ω–∞": [
      "–≤—Ö–æ–¥—è—â–∞—è",
      "–≤—Ö–æ–¥—è—â–∞—è —Ü–µ–Ω–∞"
    ],
    "–¶–µ–Ω–∞ –ë–ù": [
      "–ü—Ä–∞–π—Å –ë–ù"
    ],
    "–¶–µ–Ω–∞ –ù–ê–õ": [
      "–ü—Ä–∞–π—Å 2"
    ]
  }
}</script>

  <style>
/* ===== RESET ===== */
* { margin: 0; padding: 0; box-sizing: border-box; }

/* ===== BODY & BACKGROUND ===== */
body {
  font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Arial, sans-serif;
  background: linear-gradient(135deg, #4f8ef7 0%, #7c3aed 55%, #a21caf 100%);
  min-height: 100vh;
  padding: 0 0 32px 0;
  color: #1c1c1e;
}

/* ===== GLOBAL NAV ===== */
.global-nav {
  position: sticky;
  top: 0;
  z-index: 5000;
  background: linear-gradient(90deg, #3b6fd4 0%, #6d28d9 60%, #9c1ac4 100%);
  box-shadow: 0 4px 20px rgba(80,0,120,0.35);
  border-bottom: none;
}
.global-nav__inner {
  max-width: 100%;
  margin: 0 auto;
  padding: 0 24px;
  display: flex;
  align-items: center;
  gap: 12px;
  flex-wrap: wrap;
  min-height: 52px;
}
.global-nav__brand {
  text-decoration: none;
  font-weight: 800;
  font-size: 17px;
  color: #ffffff;
  white-space: nowrap;
  letter-spacing: -0.3px;
  text-shadow: 0 1px 4px rgba(0,0,0,0.2);
}
.global-nav__links {
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
  align-items: center;
}
.global-nav__link {
  text-decoration: none;
  font-size: 13px;
  font-weight: 650;
  color: rgba(255,255,255,0.88);
  background: rgba(255,255,255,0.13);
  border: 1px solid rgba(255,255,255,0.22);
  padding: 7px 14px;
  border-radius: 999px;
  white-space: nowrap;
  transition: transform .12s ease, background .12s ease;
}
.global-nav__link:hover {
  transform: translateY(-1px);
  background: rgba(255,255,255,0.24);
  color: #fff;
}
.global-nav__link.is-active {
  color: #6d28d9;
  background: #ffffff;
  border-color: #ffffff;
  font-weight: 700;
}

/* ===== UPLOAD SCREEN ===== */
.upload-screen {
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: calc(100vh - 52px);
  padding: 20px;
}
.upload-card {
  background: #ffffff;
  border-radius: 20px;
  padding: 40px;
  box-shadow: 0 8px 40px rgba(80,0,120,0.22);
  text-align: center;
  max-width: 440px;
  width: 100%;
  border: 2px dashed #a78bfa;
}
.upload-card h1 {
  font-size: 26px;
  font-weight: 700;
  margin-bottom: 18px;
  letter-spacing: -0.5px;
  color: #1c1c1e;
}
input[type="file"] { display: none; }
.upload-btn {
  display: inline-block;
  padding: 10px 24px;
  background: #7c3aed;
  color: #fff;
  border-radius: 12px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 700;
  border: none;
  user-select: none;
  transition: all .15s;
}
.upload-btn:hover { background: #6d28d9; transform: translateY(-1px); box-shadow: 0 3px 10px rgba(124,58,237,0.35); }

/* ===== MAIN CONTAINER ===== */
.container {
  display: none;
  padding: 24px;
  max-width: 100%;
  margin: 20px 16px 0;
  background: #ffffff;
  border-radius: 20px;
  box-shadow: 0 8px 40px rgba(80,0,120,0.22);
}

/* ===== HEADER ===== */
.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 10px;
  flex-wrap: wrap;
  margin-bottom: 14px;
  padding: 12px 16px;
  background: #f5f3ff;
  border-radius: 14px;
  border: 1.5px solid #ddd6fe;
}
.header h1 { font-size: 22px; font-weight: 700; color: #1c1c1e; letter-spacing: -0.5px; }
.file-input-wrapper { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
#fileNameDisplay { font-size: 12px; color: #7c3aed !important; margin-top: 3px; font-weight: 600; }

/* ===== HINT ===== */
.hint {
  font-size: 12px;
  color: #6d28d9;
  margin-bottom: 12px;
  padding: 10px 14px;
  background: #f5f3ff;
  border-radius: 10px;
  border-left: 3px solid #7c3aed;
  line-height: 1.35;
}

/* ===== INFO BAR / STATS ===== */
.info-bar {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
  align-items: center;
  font-size: 13px;
  margin-bottom: 10px;
}
.sheet-selector { display: none; }
.sheet-selector select {
  padding: 6px 10px;
  border-radius: 10px;
  border: 1.5px solid #c4b5fd;
  background: #faf8ff;
  font-size: 13px;
  color: #1c1c1e;
}
.stats {
  display: inline-flex;
  gap: 14px;
  padding: 8px 14px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-radius: 12px;
  font-size: 12px;
  align-items: center;
  color: white;
}
.stat-item { display: inline-flex; gap: 6px; align-items: center; }
.stat-item span:first-child { color: rgba(255,255,255,0.8); }
.stat-value { font-weight: 700; color: #ffffff; }

/* ===== ACTIONS ===== */
.actions {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  margin-bottom: 12px;
  align-items: center;
  background: #f5f3ff;
  border: 1px solid #ddd6fe;
  border-radius: 12px;
  padding: 8px 12px;
}

/* ===== BUTTONS ===== */
button {
  padding: 7px 12px;
  border: none;
  border-radius: 9px;
  cursor: pointer;
  font-weight: 700;
  font-size: 12px;
  font-family: inherit;
  transition: all 0.18s;
  line-height: 1;
  white-space: nowrap;
}
button:disabled {
  background: #e5e5ea;
  color: #aeaeb2;
  cursor: not-allowed;
  transform: none;
  box-shadow: none;
  border: 1px solid #e5e5ea;
}
.btn-primary { background: #7c3aed; color: white; }
.btn-primary:hover:not(:disabled) { background: #6d28d9; transform: translateY(-1px); box-shadow: 0 3px 10px rgba(124,58,237,0.35); }
.btn-secondary { background: #ffffff; color: #7c3aed; border: 1.5px solid #c4b5fd; }
.btn-secondary:hover:not(:disabled) { background: #ede9fe; border-color: #7c3aed; color: #6d28d9; }

/* ===== TABLE ===== */
.table-container {
  background: #fff;
  border: 1.5px solid #ddd6fe;
  border-radius: 14px;
  overflow: auto;
  max-height: calc(100vh - 230px);
}
table { width: 100%; border-collapse: collapse; font-size: 13px; }
th, td {
  padding: 5px 10px;
  border: 1px solid #ddd6fe;
  min-width: 110px;
  vertical-align: top;
}
th {
  position: sticky;
  top: 0;
  z-index: 10;
  background: #f5f3ff;
  color: #6d28d9;
  font-weight: 700;
  font-size: 11px;
  cursor: pointer;
  user-select: none;
  border-bottom: 2px solid #c4b5fd;
  transition: background .12s;
  letter-spacing: 0.3px;
}
th:hover { background: #ede9fe; }
th.selected { background: #7c3aed; color: #fff; border-color: #6d28d9; }
td { cursor: pointer; background: #fff; color: #1c1c1e; border-bottom: 1px solid #f0ebff; border-right: 1px solid #e8e0fa; }
td:hover { background: #f8f6ff; }
tr:hover { background: #f8f6ff; }
.row-hidden { display: none; }

/* ===== RENAME INPUT (inside selected th) ===== */
.rename-wrapper { position: relative; width: 100%; }
.rename-input {
  width: 100%;
  padding: 4px 6px;
  border: 1px solid rgba(255,255,255,0.3);
  border-radius: 6px;
  font-size: 11px;
  font-weight: 700;
  color: #fff;
  background: rgba(255,255,255,0.18);
  outline: none;
}
.rename-input::placeholder { color: rgba(255,255,255,0.75); }
.rename-input:focus { border-color: rgba(255,255,255,0.65); background: rgba(255,255,255,0.25); }

/* ===== DROPDOWN ===== */
.dropdown {
  position: absolute;
  top: calc(100% + 4px);
  left: 0;
  background: #fff;
  border: 1.5px solid #c4b5fd;
  border-radius: 12px;
  box-shadow: 0 6px 24px rgba(80,0,120,0.18);
  max-height: 320px;
  overflow-y: auto;
  z-index: 1000;
  display: none;
  min-width: 220px;
  color: #1c1c1e;
  text-align: left;
}
.dropdown.show { display: block; }
.dropdown-item { color: #1c1c1e; padding: 8px 12px; cursor: pointer; font-size: 13px; white-space: nowrap; text-align: left; }
.dropdown-item:hover { background: #f5f3ff; color: #6d28d9; }

/* ===== LOAD MORE ===== */
.load-more-container {
  display: none;
  margin-top: 10px;
  padding: 10px;
  background: #fff;
  border: 1.5px solid #ddd6fe;
  border-radius: 12px;
  text-align: center;
}
.btn-load-more { background: #7c3aed; color: #fff; width: 100%; }
.btn-load-more:hover { background: #6d28d9; transform: translateY(-1px); box-shadow: 0 3px 10px rgba(124,58,237,0.35); }

/* ===== MODAL ===== */
.modal {
  position: fixed;
  inset: 0;
  background: rgba(80,0,120,0.35);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 2000;
  padding: 14px;
}
.modal-content {
  width: min(980px, 96vw);
  background: #fff;
  border-radius: 20px;
  overflow: hidden;
  box-shadow: 0 12px 40px rgba(80,0,120,0.3);
}
.modal-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 10px;
  padding: 14px 18px;
  border-bottom: 1.5px solid #ddd6fe;
  font-weight: 800;
  font-size: 15px;
  color: #1c1c1e;
  background: #f5f3ff;
}
.modal-body { padding: 16px; }
.muted { color: #6d28d9; font-size: 12px; line-height: 1.35; }

/* ===== TEMPLATE BLOCKS ===== */
.template-add { display: flex; gap: 8px; margin-bottom: 12px; }
.template-add input {
  flex: 1; padding: 8px 12px; border-radius: 10px; border: 1.5px solid #c4b5fd;
  font-size: 13px; font-family: inherit; background: #faf8ff; color: #1c1c1e;
}
.template-add input:focus { outline: none; border-color: #7c3aed; box-shadow: 0 0 0 3px rgba(124,58,237,0.1); }
.template-row { display: flex; gap: 6px; align-items: center; padding: 6px 8px; background: #faf8ff; margin: 0; }
.template-row input {
  flex: 1; padding: 7px 10px; border-radius: 8px; border: 1.5px solid #c4b5fd;
  font-size: 13px; font-family: inherit; background: #fff; color: #1c1c1e;
}
.template-row input:focus { outline: none; border-color: #7c3aed; }
.template-block { border: 1.5px solid #ddd6fe; border-radius: 12px; margin-bottom: 8px; overflow: hidden; }
.btn-icon { padding: 4px 9px !important; min-width: 28px; font-size: 14px; line-height: 1; }
.btn-icon:disabled { opacity: .35; }
.synonyms-panel { padding: 8px 12px 10px; background: #f5f3ff; border-top: 1px solid #ddd6fe; }
.synonyms-label { font-size: 11px; color: #7c3aed; margin-bottom: 6px; font-weight: 700; letter-spacing: .05em; text-transform: uppercase; }
.synonyms-chips { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 8px; min-height: 26px; }
.synonym-chip { display: inline-flex; align-items: center; background: #ede9fe; border: 1px solid #c4b5fd; border-radius: 8px; padding: 2px 2px 2px 8px; gap: 2px; }
.synonym-input { border: none; background: transparent; font-size: 12px; padding: 1px 3px; width: 130px; outline: none; color: #1c1c1e; }
.synonym-remove { background: none; border: none; cursor: pointer; font-size: 15px; color: #a78bfa; padding: 0 3px; line-height: 1; font-weight: 700; }
.synonym-remove:hover { color: #e11d48; background: none; }
.synonym-add-row { display: flex; gap: 6px; align-items: center; margin-top: 4px; }
.synonym-new-input { flex: 1; padding: 5px 8px; border-radius: 8px; border: 1.5px solid #c4b5fd; font-size: 12px; background: #fff; font-family: inherit; }
.synonym-new-input:focus { outline: none; border-color: #7c3aed; }
.syn-toggle-btn { font-size: 12px !important; padding: 5px 10px !important; }
#templatesModal .modal-body { max-height: 72vh; overflow-y: auto; }

/* ===== SKIPPED ROWS MODAL ===== */
.skipped-wrap { border: 1.5px solid #ddd6fe; border-radius: 12px; overflow: auto; max-height: 55vh; background: #fff; margin-top: 10px; }
.skipped-table th { position: sticky; top: 0; z-index: 2; cursor: default; }
.skipped-actions { display: flex; gap: 8px; justify-content: flex-end; flex-wrap: wrap; margin-top: 10px; }

/* ===== RESPONSIVE ===== */
@media (max-width: 768px) { .container { margin: 12px 8px 0; padding: 16px; } }
:root { --global-nav-h: 52px; }
</style>
</head>

<body>
<header class="global-nav">
  <div class="global-nav__inner">
    <a class="global-nav__brand" href="https://erofly83-arch.github.io/pricematcher/">
      –ù–∞–≤–∏–≥–∞—Ç–æ—Ä
    </a>

    <nav class="global-nav__links" aria-label="–ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è–º">
      <a class="global-nav__link" href="https://erofly83-arch.github.io/synonyms/" data-match="/synonyms/">
        –†–µ–¥–∞–∫—Ç–æ—Ä JSON
      </a>
      <a class="global-nav__link" href="https://erofly83-arch.github.io/pricematcher/" data-match="/pricematcher/">
        –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
      </a>
      <a class="global-nav__link is-active" href="https://erofly83-arch.github.io/obrezatel/" data-match="/obrezatel/">
        –û–±—Ä–µ–∑–∞—Ç–µ–ª—å
      </a>
      <a class="global-nav__link" href="https://erofly83-arch.github.io/sininimfinder/" data-match="/sininimfinder/">
        –ü–æ–∏—Å–∫ —Å–∏–Ω–æ–Ω–∏–º–æ–≤
      </a>
    </nav>
  </div>
</header>
  <!-- Upload -->
  <div class="upload-screen" id="uploadScreen" style="display: flex;">
    <div class="upload-card">
      <h1>üìä Table to CSV</h1>
      <input type="file" id="fileInput" accept=".xlsx,.xls,.xlsb,.xlsm,.xml,.csv,.ods,.fods,.txt,.dbf,.dif,.sylk,.prn">
      <label for="fileInput" class="upload-btn">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª</label>
    </div>
  </div>

  <!-- Main -->
  <div class="container" id="tableContainer" style="display: none;">
    <div class="header">
      <div>
        <h1>üìä Table to CSV</h1>
        <div id="fileNameDisplay" style="font-size:12px;color:#555;margin-top:3px;">üìÇ –í–æ—Å—Ç –Ω–∞–ª –∏ –±–∞–Ω–∫ 17.02.xls</div>
      </div>

      <div class="file-input-wrapper">
        <input type="file" id="fileInput2" accept=".xlsx,.xls,.xlsb,.xlsm,.xml,.csv,.ods,.fods,.txt,.dbf,.dif,.sylk,.prn">
        <label for="fileInput2" class="upload-btn" style="padding: 6px 14px; font-size: 13px;">–ó–∞–≥—Ä—É–∑–∏—Ç—å –¥—Ä—É–≥–æ–π —Ñ–∞–π–ª</label>

        <div class="sheet-selector" id="sheetSelector" style="display: none;">
          <select id="sheetSelect"></select>
        </div>
      </div>
    </div>

    <div class="hint">
      <strong>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:</strong> –ü–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞ –∫–æ–ª–æ–Ω–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º –≤ –ø–µ—Ä–≤—ã—Ö 15 —Å—Ç—Ä–æ–∫–∞—Ö. –ö–ª–∏–∫ –ø–æ –∑–∞–≥–æ–ª–æ–≤–∫—É –≤—ã–±–∏—Ä–∞–µ—Ç/—Å–Ω–∏–º–∞–µ—Ç –∫–æ–ª–æ–Ω–∫—É ‚Üí –º–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –∏–ª–∏ –≤–≤–µ—Å—Ç–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –≤—Ä—É—á–Ω—É—é ‚Üí –∫–ª–∏–∫ –ø–æ —Å—Ç—Ä–æ–∫–µ —Å–∫—Ä—ã–≤–∞–µ—Ç –≤—Å–µ —Å—Ç—Ä–æ–∫–∏ –≤—ã—à–µ.
    </div>

    <div class="info-bar">
      <div class="stats">
        <div class="stat-item"><span>–ö–æ–ª–æ–Ω–æ–∫:</span><span class="stat-value" id="totalColumns">0</span></div>
        <div class="stat-item"><span>–í—ã–±—Ä–∞–Ω–æ:</span><span class="stat-value" id="selectedColumns">0</span></div>
        <div class="stat-item"><span>–°—Ç—Ä–æ–∫:</span><span class="stat-value" id="totalRows">0</span></div>
      </div>
    </div>

    <div class="actions">
      <button class="btn-primary" id="downloadBtn" disabled="">‚¨áÔ∏è –°–∫–∞—á–∞—Ç—å CSV</button>
      <button class="btn-secondary" id="resetBtn">üîÑ –°–±—Ä–æ—Å–∏—Ç—å</button>
      <button class="btn-secondary" id="manageTemplatesBtn">üìù –ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è</button>
      <button class="btn-secondary" id="saveAppBtn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>

    <div class="table-container">
      <table id="dataTable"></table>
    </div>

    <div class="load-more-container" id="loadMoreContainer" style="display: none;">
      <button class="btn-load-more" id="loadMoreBtn">–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ —Å—Ç—Ä–æ–∫–∏ (<span id="remainingRows">0</span>)</button>
    </div>
  </div>

  <!-- Templates modal -->
  <div class="modal" id="templatesModal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <div>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è –∫–æ–ª–æ–Ω–æ–∫</div>
        <button class="btn-secondary" id="closeTemplatesModal">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
      <div class="modal-body">
        <div class="template-add">
          <input id="newTemplateInput" type="text" placeholder="–î–æ–±–∞–≤–∏—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä: –®—Ç—Ä–∏—Ö–∫–æ–¥)">
          <button class="btn-primary" id="addTemplateBtn">–î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
        <div id="templatesList"><div class="template-block"><div class="template-row"><button class="btn-secondary btn-icon" title="–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤–≤–µ—Ä—Ö" disabled="">‚Üë</button><button class="btn-secondary btn-icon" title="–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤–Ω–∏–∑">‚Üì</button><input type="text"><button class="btn-secondary syn-toggle-btn" title="–ü–æ–∫–∞–∑–∞—Ç—å / —Å–∫—Ä—ã—Ç—å —Å–∏–Ω–æ–Ω–∏–º—ã">üî§ –°–∏–Ω–æ–Ω–∏–º—ã</button><button class="btn-secondary">–£–¥–∞–ª–∏—Ç—å</button></div><div class="synonyms-panel" style="display: none;"><div class="synonyms-label">–°–∏–Ω–æ–Ω–∏–º—ã (—Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ, –±–µ–∑ —É—á—ë—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞):</div><div class="synonyms-chips"><div class="synonym-chip"><input type="text" class="synonym-input" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–∏–Ω–æ–Ω–∏–º"><button class="synonym-remove" title="–£–¥–∞–ª–∏—Ç—å">√ó</button></div></div><div class="synonym-add-row"><input type="text" placeholder="–ù–æ–≤—ã–π —Å–∏–Ω–æ–Ω–∏–º‚Ä¶" class="synonym-new-input"><button class="btn-primary" style="font-size: 12px; padding: 5px 10px;">+ –î–æ–±–∞–≤–∏—Ç—å</button></div></div></div><div class="template-block"><div class="template-row"><button class="btn-secondary btn-icon" title="–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤–≤–µ—Ä—Ö">‚Üë</button><button class="btn-secondary btn-icon" title="–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤–Ω–∏–∑">‚Üì</button><input type="text"><button class="btn-secondary syn-toggle-btn" title="–ü–æ–∫–∞–∑–∞—Ç—å / —Å–∫—Ä—ã—Ç—å —Å–∏–Ω–æ–Ω–∏–º—ã">üî§ –°–∏–Ω–æ–Ω–∏–º—ã</button><button class="btn-secondary">–£–¥–∞–ª–∏—Ç—å</button></div><div class="synonyms-panel" style="display: none;"><div class="synonyms-label">–°–∏–Ω–æ–Ω–∏–º—ã (—Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ, –±–µ–∑ —É—á—ë—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞):</div><div class="synonyms-chips"><div class="synonym-chip"><input type="text" class="synonym-input" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–∏–Ω–æ–Ω–∏–º"><button class="synonym-remove" title="–£–¥–∞–ª–∏—Ç—å">√ó</button></div></div><div class="synonym-add-row"><input type="text" placeholder="–ù–æ–≤—ã–π —Å–∏–Ω–æ–Ω–∏–º‚Ä¶" class="synonym-new-input"><button class="btn-primary" style="font-size: 12px; padding: 5px 10px;">+ –î–æ–±–∞–≤–∏—Ç—å</button></div></div></div><div class="template-block"><div class="template-row"><button class="btn-secondary btn-icon" title="–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤–≤–µ—Ä—Ö">‚Üë</button><button class="btn-secondary btn-icon" title="–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤–Ω–∏–∑">‚Üì</button><input type="text"><button class="btn-secondary syn-toggle-btn" title="–ü–æ–∫–∞–∑–∞—Ç—å / —Å–∫—Ä—ã—Ç—å —Å–∏–Ω–æ–Ω–∏–º—ã">üî§ –°–∏–Ω–æ–Ω–∏–º—ã</button><button class="btn-secondary">–£–¥–∞–ª–∏—Ç—å</button></div><div class="synonyms-panel" style="display: none;"><div class="synonyms-label">–°–∏–Ω–æ–Ω–∏–º—ã (—Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ, –±–µ–∑ —É—á—ë—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞):</div><div class="synonyms-chips"></div><div class="synonym-add-row"><input type="text" placeholder="–ù–æ–≤—ã–π —Å–∏–Ω–æ–Ω–∏–º‚Ä¶" class="synonym-new-input"><button class="btn-primary" style="font-size: 12px; padding: 5px 10px;">+ –î–æ–±–∞–≤–∏—Ç—å</button></div></div></div><div class="template-block"><div class="template-row"><button class="btn-secondary btn-icon" title="–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤–≤–µ—Ä—Ö">‚Üë</button><button class="btn-secondary btn-icon" title="–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤–Ω–∏–∑">‚Üì</button><input type="text"><button class="btn-secondary syn-toggle-btn" title="–ü–æ–∫–∞–∑–∞—Ç—å / —Å–∫—Ä—ã—Ç—å —Å–∏–Ω–æ–Ω–∏–º—ã">üî§ –°–∏–Ω–æ–Ω–∏–º—ã</button><button class="btn-secondary">–£–¥–∞–ª–∏—Ç—å</button></div><div class="synonyms-panel" style="display: none;"><div class="synonyms-label">–°–∏–Ω–æ–Ω–∏–º—ã (—Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ, –±–µ–∑ —É—á—ë—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞):</div><div class="synonyms-chips"></div><div class="synonym-add-row"><input type="text" placeholder="–ù–æ–≤—ã–π —Å–∏–Ω–æ–Ω–∏–º‚Ä¶" class="synonym-new-input"><button class="btn-primary" style="font-size: 12px; padding: 5px 10px;">+ –î–æ–±–∞–≤–∏—Ç—å</button></div></div></div><div class="template-block"><div class="template-row"><button class="btn-secondary btn-icon" title="–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤–≤–µ—Ä—Ö">‚Üë</button><button class="btn-secondary btn-icon" title="–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤–Ω–∏–∑">‚Üì</button><input type="text"><button class="btn-secondary syn-toggle-btn" title="–ü–æ–∫–∞–∑–∞—Ç—å / —Å–∫—Ä—ã—Ç—å —Å–∏–Ω–æ–Ω–∏–º—ã">üî§ –°–∏–Ω–æ–Ω–∏–º—ã</button><button class="btn-secondary">–£–¥–∞–ª–∏—Ç—å</button></div><div class="synonyms-panel" style="display: none;"><div class="synonyms-label">–°–∏–Ω–æ–Ω–∏–º—ã (—Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ, –±–µ–∑ —É—á—ë—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞):</div><div class="synonyms-chips"><div class="synonym-chip"><input type="text" class="synonym-input" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–∏–Ω–æ–Ω–∏–º"><button class="synonym-remove" title="–£–¥–∞–ª–∏—Ç—å">√ó</button></div><div class="synonym-chip"><input type="text" class="synonym-input" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–∏–Ω–æ–Ω–∏–º"><button class="synonym-remove" title="–£–¥–∞–ª–∏—Ç—å">√ó</button></div></div><div class="synonym-add-row"><input type="text" placeholder="–ù–æ–≤—ã–π —Å–∏–Ω–æ–Ω–∏–º‚Ä¶" class="synonym-new-input"><button class="btn-primary" style="font-size: 12px; padding: 5px 10px;">+ –î–æ–±–∞–≤–∏—Ç—å</button></div></div></div><div class="template-block"><div class="template-row"><button class="btn-secondary btn-icon" title="–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤–≤–µ—Ä—Ö">‚Üë</button><button class="btn-secondary btn-icon" title="–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤–Ω–∏–∑">‚Üì</button><input type="text"><button class="btn-secondary syn-toggle-btn" title="–ü–æ–∫–∞–∑–∞—Ç—å / —Å–∫—Ä—ã—Ç—å —Å–∏–Ω–æ–Ω–∏–º—ã">üî§ –°–∏–Ω–æ–Ω–∏–º—ã</button><button class="btn-secondary">–£–¥–∞–ª–∏—Ç—å</button></div><div class="synonyms-panel" style="display: none;"><div class="synonyms-label">–°–∏–Ω–æ–Ω–∏–º—ã (—Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ, –±–µ–∑ —É—á—ë—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞):</div><div class="synonyms-chips"><div class="synonym-chip"><input type="text" class="synonym-input" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–∏–Ω–æ–Ω–∏–º"><button class="synonym-remove" title="–£–¥–∞–ª–∏—Ç—å">√ó</button></div><div class="synonym-chip"><input type="text" class="synonym-input" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–∏–Ω–æ–Ω–∏–º"><button class="synonym-remove" title="–£–¥–∞–ª–∏—Ç—å">√ó</button></div><div class="synonym-chip"><input type="text" class="synonym-input" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–∏–Ω–æ–Ω–∏–º"><button class="synonym-remove" title="–£–¥–∞–ª–∏—Ç—å">√ó</button></div><div class="synonym-chip"><input type="text" class="synonym-input" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–∏–Ω–æ–Ω–∏–º"><button class="synonym-remove" title="–£–¥–∞–ª–∏—Ç—å">√ó</button></div></div><div class="synonym-add-row"><input type="text" placeholder="–ù–æ–≤—ã–π —Å–∏–Ω–æ–Ω–∏–º‚Ä¶" class="synonym-new-input"><button class="btn-primary" style="font-size: 12px; padding: 5px 10px;">+ –î–æ–±–∞–≤–∏—Ç—å</button></div></div></div><div class="template-block"><div class="template-row"><button class="btn-secondary btn-icon" title="–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤–≤–µ—Ä—Ö">‚Üë</button><button class="btn-secondary btn-icon" title="–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤–Ω–∏–∑">‚Üì</button><input type="text"><button class="btn-secondary syn-toggle-btn" title="–ü–æ–∫–∞–∑–∞—Ç—å / —Å–∫—Ä—ã—Ç—å —Å–∏–Ω–æ–Ω–∏–º—ã">üî§ –°–∏–Ω–æ–Ω–∏–º—ã</button><button class="btn-secondary">–£–¥–∞–ª–∏—Ç—å</button></div><div class="synonyms-panel" style="display: none;"><div class="synonyms-label">–°–∏–Ω–æ–Ω–∏–º—ã (—Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ, –±–µ–∑ —É—á—ë—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞):</div><div class="synonyms-chips"><div class="synonym-chip"><input type="text" class="synonym-input" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–∏–Ω–æ–Ω–∏–º"><button class="synonym-remove" title="–£–¥–∞–ª–∏—Ç—å">√ó</button></div><div class="synonym-chip"><input type="text" class="synonym-input" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–∏–Ω–æ–Ω–∏–º"><button class="synonym-remove" title="–£–¥–∞–ª–∏—Ç—å">√ó</button></div><div class="synonym-chip"><input type="text" class="synonym-input" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–∏–Ω–æ–Ω–∏–º"><button class="synonym-remove" title="–£–¥–∞–ª–∏—Ç—å">√ó</button></div><div class="synonym-chip"><input type="text" class="synonym-input" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–∏–Ω–æ–Ω–∏–º"><button class="synonym-remove" title="–£–¥–∞–ª–∏—Ç—å">√ó</button></div></div><div class="synonym-add-row"><input type="text" placeholder="–ù–æ–≤—ã–π —Å–∏–Ω–æ–Ω–∏–º‚Ä¶" class="synonym-new-input"><button class="btn-primary" style="font-size: 12px; padding: 5px 10px;">+ –î–æ–±–∞–≤–∏—Ç—å</button></div></div></div><div class="template-block"><div class="template-row"><button class="btn-secondary btn-icon" title="–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤–≤–µ—Ä—Ö">‚Üë</button><button class="btn-secondary btn-icon" title="–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤–Ω–∏–∑" disabled="">‚Üì</button><input type="text"><button class="btn-secondary syn-toggle-btn" title="–ü–æ–∫–∞–∑–∞—Ç—å / —Å–∫—Ä—ã—Ç—å —Å–∏–Ω–æ–Ω–∏–º—ã">üî§ –°–∏–Ω–æ–Ω–∏–º—ã</button><button class="btn-secondary">–£–¥–∞–ª–∏—Ç—å</button></div><div class="synonyms-panel" style="display: none;"><div class="synonyms-label">–°–∏–Ω–æ–Ω–∏–º—ã (—Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ, –±–µ–∑ —É—á—ë—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞):</div><div class="synonyms-chips"><div class="synonym-chip"><input type="text" class="synonym-input" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–∏–Ω–æ–Ω–∏–º"><button class="synonym-remove" title="–£–¥–∞–ª–∏—Ç—å">√ó</button></div><div class="synonym-chip"><input type="text" class="synonym-input" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–∏–Ω–æ–Ω–∏–º"><button class="synonym-remove" title="–£–¥–∞–ª–∏—Ç—å">√ó</button></div></div><div class="synonym-add-row"><input type="text" placeholder="–ù–æ–≤—ã–π —Å–∏–Ω–æ–Ω–∏–º‚Ä¶" class="synonym-new-input"><button class="btn-primary" style="font-size: 12px; padding: 5px 10px;">+ –î–æ–±–∞–≤–∏—Ç—å</button></div></div></div></div>
        <div class="hint" style="margin-top: 10px;">
          –ò–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ–ø–∞–¥—É—Ç –≤ –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ –∏ —Å–æ—Ö—Ä–∞–Ω—è—Ç—Å—è –≤ —Ñ–∞–π–ª –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ ¬´–°–æ—Ö—Ä–∞–Ω–∏—Ç—å¬ª.
        </div>
      </div>
    </div>
  </div>

  <!-- Skipped modal -->
  <div class="modal" id="skippedModal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <div>–ü—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏</div>
        <button class="btn-secondary" id="closeSkippedModal">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
      <div class="modal-body">
        <div id="skippedSummary" class="muted">–í—Å–µ–≥–æ –ø—Ä–æ–ø—É—Å–∫–æ–≤: 476. –°–∫—Ä—ã—Ç–æ –ø—É—Å—Ç—ã—Ö: 472. –ü–æ–∫–∞–∑–∞–Ω–æ: 4.</div>

        <div class="skipped-wrap">
          <table class="skipped-table" id="skippedTable"><thead><tr><th style="min-width:90px;">–°—Ç—Ä–æ–∫–∞</th><th style="min-width:240px;">–®—Ç—Ä–∏—Ö–∫–æ–¥ (–∫–∞–∫ –≤ —Ñ–∞–π–ª–µ)</th><th style="min-width:240px;">–ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π</th><th style="min-width:260px;">–ü—Ä–∏—á–∏–Ω–∞</th></tr></thead><tbody><tr><td>2</td><td>–®—Ç—Ä–∏—Ö-–∫–æ–¥</td><td></td><td>–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —à—Ç—Ä–∏—Ö–∫–æ–¥</td></tr><tr><td>2151</td><td>7CP-5GP-0100</td><td></td><td>–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —à—Ç—Ä–∏—Ö–∫–æ–¥</td></tr><tr><td>4668</td><td>2020-08</td><td></td><td>–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —à—Ç—Ä–∏—Ö–∫–æ–¥</td></tr><tr><td>4670</td><td>2021-08</td><td></td><td>–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —à—Ç—Ä–∏—Ö–∫–æ–¥</td></tr></tbody></table>
        </div>

        <div class="skipped-actions">
          <button class="btn-secondary" id="downloadSkippedBtn">‚¨áÔ∏è –°–∫–∞—á–∞—Ç—å —Å–ø–∏—Å–æ–∫ –ø—Ä–æ–ø—É—Å–∫–æ–≤</button>
          <button class="btn-primary" id="confirmDownloadCsvBtn">‚¨áÔ∏è –°–∫–∞—á–∞—Ç—å CSV</button>
        </div>

        <div class="muted" style="margin-top: 8px;">
          –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: CSV –±—É–¥–µ—Ç —Å–∫–∞—á–∞–Ω –¥–∞–∂–µ –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –ø—Ä–æ–ø—É—Å–∫–æ–≤. –í—ã –º–æ–∂–µ—Ç–µ –∑–∞–∫—Ä—ã—Ç—å —ç—Ç–æ –æ–∫–Ω–æ, –∏—Å–ø—Ä–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ/–≤—ã–±–æ—Ä –∫–æ–ª–æ–Ω–æ–∫ –∏ —Å–∫–∞—á–∞—Ç—å —Å–Ω–æ–≤–∞.
        </div>
      </div>
    </div>
  </div>

  <script>
    // --- Editable templates ---
    const DEFAULT_COLUMN_TEMPLATES = [
      "–®—Ç—Ä–∏—Ö–∫–æ–¥",
      "EAN",
      "–ê—Ä—Ç–∏–∫—É–ª",
      "–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ",
      "–ë—Ä–µ–Ω–¥",
      "–ö–∞—Ç–µ–≥–æ—Ä–∏—è",
      "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ",
      "–¶–µ–Ω–∞",
      "–°—É–º–º–∞",
      "–°–∫–ª–∞–¥",
      "300..",
      "750.."
    ];

    function getUserConfig() {
      const el = document.getElementById("userConfig");
      if (!el) return {};
      try { return JSON.parse(el.textContent || "{}"); } catch { return {}; }
    }
    function setUserConfig(cfg) {
      const el = document.getElementById("userConfig");
      if (!el) return;
      el.textContent = JSON.stringify(cfg, null, 2);
    }

    function loadColumnTemplates() {
      const cfg = getUserConfig();
      if (Array.isArray(cfg.columnTemplates) && cfg.columnTemplates.length) return cfg.columnTemplates;

      const raw = localStorage.getItem("columnTemplates");
      if (raw) {
        try {
          const arr = JSON.parse(raw);
          if (Array.isArray(arr) && arr.length) return arr;
        } catch {}
      }
      return DEFAULT_COLUMN_TEMPLATES.slice();
    }

    const DEFAULT_COLUMN_SYNONYMS = {
      "–®—Ç—Ä–∏—Ö–∫–æ–¥":     ["—à—Ç—Ä–∏—Ö–∫–æ–¥ —à—Ç—É–∫–∞", "—à—Ç—Ä–∏—Ö-–∫–æ–¥", "—à—Ç—Ä–∏—Ö–∫–æ–¥", "barcode", "ean"],
      "–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ": ["–Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞", "–Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–≤", "–Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞", "–Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ"],
      "–û—Å—Ç–∞—Ç–æ–∫":      ["—Å–≤–æ–±–æ–¥–Ω—ã–π"],
      "–¶–µ–Ω–∞":         ["–≤—Ö–æ–¥—è—â–∞—è"]
    };
    function loadColumnSynonyms() {
      const cfg = getUserConfig();
      if (cfg.columnSynonyms && typeof cfg.columnSynonyms === "object") return cfg.columnSynonyms;
      const raw = localStorage.getItem("columnSynonyms");
      if (raw) { try { const o = JSON.parse(raw); if (o && typeof o === "object") return o; } catch {} }
      return JSON.parse(JSON.stringify(DEFAULT_COLUMN_SYNONYMS));
    }
    function persistAll() {
      const cfg = getUserConfig();
      cfg.columnTemplates = columnTemplates.slice();
      cfg.columnSynonyms = columnSynonyms;
      setUserConfig(cfg);
      localStorage.setItem("columnTemplates", JSON.stringify(columnTemplates));
      localStorage.setItem("columnSynonyms", JSON.stringify(columnSynonyms));
    }
    function persistColumnTemplates() { persistAll(); }
    let columnTemplates = loadColumnTemplates();
    let columnSynonyms  = loadColumnSynonyms();
    persistAll();

    // --- App state ---
    let tableData = null;
    let selectedColumns = new Map(); // colIndex -> userName
    let startRowIndex = 0;
    let currentWorkbook = null;
    let displayedRows = 50;
    let activeDropdown = null;
    let originalFileName = "export";

    // download-pending
    let pendingCsvContent = null;
    let pendingCsvFileName = null;
    let pendingSkippedRows = [];

    // --- DOM refs ---
    const uploadScreen = document.getElementById("uploadScreen");
    const fileInput = document.getElementById("fileInput");
    const fileInput2 = document.getElementById("fileInput2");
    const tableContainer = document.getElementById("tableContainer");
    const dataTable = document.getElementById("dataTable");

    const downloadBtn = document.getElementById("downloadBtn");
    const resetBtn = document.getElementById("resetBtn");
    const manageTemplatesBtn = document.getElementById("manageTemplatesBtn");
    const saveAppBtn = document.getElementById("saveAppBtn");
    const fileNameDisplay = document.getElementById("fileNameDisplay");

    const sheetSelector = document.getElementById("sheetSelector");
    const sheetSelect = document.getElementById("sheetSelect");

    const loadMoreBtn = document.getElementById("loadMoreBtn");
    const loadMoreContainer = document.getElementById("loadMoreContainer");

    const templatesModal = document.getElementById("templatesModal");
    const closeTemplatesModal = document.getElementById("closeTemplatesModal");
    const newTemplateInput = document.getElementById("newTemplateInput");
    const addTemplateBtn = document.getElementById("addTemplateBtn");
    const templatesList = document.getElementById("templatesList");

    const skippedModal = document.getElementById("skippedModal");
    const closeSkippedModal = document.getElementById("closeSkippedModal");
    const skippedSummary = document.getElementById("skippedSummary");
    const skippedTable = document.getElementById("skippedTable");
    const confirmDownloadCsvBtn = document.getElementById("confirmDownloadCsvBtn");
    const downloadSkippedBtn = document.getElementById("downloadSkippedBtn");

    // Close dropdown on outside click
    document.addEventListener("click", function(e) {
      const inRename = !!e.target.closest(".rename-wrapper");
      const inModal = !!e.target.closest(".modal-content");
      if (!inRename && !inModal && activeDropdown) {
        activeDropdown.classList.remove("show");
        activeDropdown = null;
      }
    });

    // --- File load ---
    fileInput.addEventListener("change", handleFileUpload);
    fileInput2.addEventListener("change", handleFileUpload);

    function handleFileUpload(event) {
      const file = event.target.files && event.target.files[0];
      if (!file) return;

      originalFileName = (file.name || "export").replace(/\.[^.]+$/, "");
      if (fileNameDisplay) fileNameDisplay.textContent = "üìÇ " + (file.name || "");

      const reader = new FileReader();
      reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        try {
          currentWorkbook = XLSX.read(data, { type: "array" });

          if (currentWorkbook.SheetNames.length > 1) {
            sheetSelect.innerHTML = "";
            currentWorkbook.SheetNames.forEach((name, index) => {
              const option = document.createElement("option");
              option.value = String(index);
              option.textContent = name;
              sheetSelect.appendChild(option);
            });
            sheetSelector.style.display = "block";
          } else {
            sheetSelector.style.display = "none";
          }

          loadSheet(0);
          uploadScreen.style.display = "none";
          tableContainer.style.display = "block";
        } catch (err) {
          alert(err && err.message ? err.message : String(err));
          console.error(err);
        }
      };
      reader.readAsArrayBuffer(file);
    }

    sheetSelect.addEventListener("change", function() {
      const idx = parseInt(sheetSelect.value, 10) || 0;
      loadSheet(idx);
    });

    // --- Auto-detect column names from first 15 rows (exact match, case-insensitive) ---
    function autoDetectColumns() {
      if (!tableData || tableData.length === 0) return;
      const SCAN_ROWS = 15;
      const maxCols = Math.max(0, ...tableData.map(r => r ? r.length : 0));
      for (let col = 0; col < maxCols; col++) {
        if (selectedColumns.has(col)) continue;
        for (let row = 0; row < Math.min(SCAN_ROWS, tableData.length); row++) {
          const cell = (tableData[row] || [])[col];
          if (cell === undefined || cell === null) continue;
          const norm = String(cell).toLowerCase().replace(/\s+/g, " ").trim();
          if (!norm) continue;
          let matched = false;
          for (const tplName of columnTemplates) {
            const synonyms = (columnSynonyms[tplName] || []).filter(Boolean);
            for (const syn of synonyms) {
              const synNorm = syn.toLowerCase().replace(/\s+/g, " ").trim();
              // –¢–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –±–µ–∑ —É—á—ë—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞
              if (synNorm && norm === synNorm) {
                selectedColumns.set(col, tplName);
                matched = true;
                break;
              }
            }
            if (matched) break;
          }
          if (matched) break;
        }
      }
    }

        function loadSheet(sheetIndex) {
      if (!currentWorkbook) return;
      const sheetName = currentWorkbook.SheetNames[sheetIndex];
      const worksheet = currentWorkbook.Sheets[sheetName];
      const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: "", raw: true });

      tableData = jsonData;
      startRowIndex = 0;
      selectedColumns.clear();
      displayedRows = Math.min(50, tableData.length);

      autoDetectColumns();
      renderTable();
      updateLoadMoreButton();
    }

    // --- Render ---
    function escapeHtml(text) {
      return String(text)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function renderTable() {
      if (!tableData || tableData.length === 0) {
        dataTable.innerHTML = "<tr><td>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>";
        updateStats();
        return;
      }

      const maxCols = Math.max(0, ...tableData.map(r => (r ? r.length : 0)));
      const rowsToShow = Math.min(displayedRows, tableData.length);

      let html = "<thead><tr>";
      for (let i = 0; i < maxCols; i++) {
        const isSelected = selectedColumns.has(i);
        const customName = selectedColumns.get(i);
        html += `<th class="${isSelected ? "selected" : ""}" data-col="${i}">`;
        if (isSelected) html += createRenameInput(i, customName);
        else html += escapeHtml(String(i + 1));
        html += "</th>";
      }
      html += "</tr></thead><tbody>";

      for (let rowIndex = 0; rowIndex < rowsToShow; rowIndex++) {
        const row = tableData[rowIndex] || [];
        const isHidden = rowIndex < startRowIndex;
        html += `<tr class="${isHidden ? "row-hidden" : ""}" data-row-index="${rowIndex}">`;
        for (let i = 0; i < maxCols; i++) {
          const cellValue = (row[i] !== undefined && row[i] !== null) ? row[i] : "";
          html += `<td data-row="${rowIndex}" data-col="${i}">${escapeHtml(cellValue)}</td>`;
        }
        html += "</tr>";
      }
      html += "</tbody>";

      dataTable.innerHTML = html;
      attachEventListeners();
      updateStats();
    }

    function createRenameInput(colIndex, value) {
      const escapedValue = String(value || "").replaceAll('"', "&quot;");
      const itemsHtml = columnTemplates
        .filter(Boolean)
        .map(t => {
          const safeText = escapeHtml(t);
          const safeAttr = String(t).replaceAll('"', "&quot;");
          return `<div class="dropdown-item" data-value="${safeAttr}">${safeText}</div>`;
        })
        .join("");

      return `
        <div class="rename-wrapper" data-col="${colIndex}">
          <input type="text" class="rename-input" value="${escapedValue}" data-col="${colIndex}" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ"/>
          <div class="dropdown" data-col="${colIndex}">${itemsHtml}</div>
        </div>
      `;
    }

    function openDropdownForColumn(colIndex, focus = true) {
      const input = document.querySelector(`.rename-input[data-col="${colIndex}"]`);
      const dropdown = document.querySelector(`.dropdown[data-col="${colIndex}"]`);
      if (!input || !dropdown) return;

      if (activeDropdown && activeDropdown !== dropdown) activeDropdown.classList.remove("show");
      dropdown.classList.add("show");
      activeDropdown = dropdown;

      if (focus) {
        input.focus();
        input.select();
      }
    }

    function attachEventListeners() {
      // Header click: select/unselect (ignore input clicks)
      document.querySelectorAll("th").forEach(th => {
        th.addEventListener("click", function(e) {
          if (e.target.closest(".rename-wrapper")) return;
          const colIndex = parseInt(th.dataset.col, 10);

          const wasSelected = selectedColumns.has(colIndex);
          if (wasSelected) {
            selectedColumns.delete(colIndex);
            renderTable();
            return;
          }

          selectedColumns.set(colIndex, "");
          renderTable();
          requestAnimationFrame(() => openDropdownForColumn(colIndex, true));
        });
      });

      // Input events
      document.querySelectorAll(".rename-input").forEach(input => {
        input.addEventListener("click", function(e) {
          e.stopPropagation();
          openDropdownForColumn(parseInt(e.target.dataset.col, 10), false);
        });
        input.addEventListener("input", function(e) {
          const colIndex = parseInt(e.target.dataset.col, 10);
          selectedColumns.set(colIndex, e.target.value);
          updateStats();
        });
        input.addEventListener("focus", function(e) {
          e.target.select();
        });
      });

      // Dropdown pick
      document.querySelectorAll(".dropdown-item").forEach(item => {
        item.addEventListener("click", function(e) {
          e.stopPropagation();
          const value = e.target.dataset.value || "";
          const dropdown = e.target.closest(".dropdown");
          const colIndex = parseInt(dropdown.dataset.col, 10);
          const input = document.querySelector(`.rename-input[data-col="${colIndex}"]`);
          if (!input) return;

          input.value = value;
          selectedColumns.set(colIndex, value);

          dropdown.classList.remove("show");
          activeDropdown = null;

          updateStats();
        });
      });

      // Row click: hide all rows above
      document.querySelectorAll("td").forEach(td => {
        td.addEventListener("click", function() {
          startRowIndex = parseInt(td.dataset.row, 10) || 0;
          renderTable();
        });
      });
    }

    function updateLoadMoreButton() {
      const remaining = (tableData ? tableData.length : 0) - displayedRows;
      if (remaining > 0) {
        loadMoreContainer.style.display = "block";
        document.getElementById("remainingRows").textContent = String(remaining);
      } else {
        loadMoreContainer.style.display = "none";
      }
    }

    loadMoreBtn.addEventListener("click", function() {
      displayedRows = tableData ? tableData.length : displayedRows;
      renderTable();
      updateLoadMoreButton();
    });

    function updateStats() {
      const maxCols = tableData && tableData.length > 0
        ? Math.max(0, ...tableData.map(r => (r ? r.length : 0)))
        : 0;

      document.getElementById("totalColumns").textContent = String(maxCols);
      document.getElementById("selectedColumns").textContent = String(selectedColumns.size);
      document.getElementById("totalRows").textContent = String(Math.max(0, (tableData ? tableData.length : 0) - startRowIndex));

      downloadBtn.disabled = selectedColumns.size === 0;
    }

    // --- CSV helpers ---
    function escapeCSV(value) {
      if (value === null || value === undefined) return "";
      const s = String(value);
      if (s.includes('"') || s.includes(",") || s.includes("\n") || s.includes("\r")) {
        return `"${s.replaceAll('"', '""')}"`;
      }
      return s;
    }

    function normalizeHeaderName(name) {
      return String(name || "")
        .toLowerCase()
        .trim()
        .replaceAll("—ë", "–µ")
        .replaceAll(/\s+/g, " ")
        .replaceAll(/[^\p{L}\p{N} ]/gu, ""); // —É–±–∏—Ä–∞–µ–º –ø—É–Ω–∫—Ç—É–∞—Ü–∏—é (unicode)
    }

    // –í–ê–ñ–ù–û: —Ç–µ–ø–µ—Ä—å —É–¥–∞–ª—è–µ–º —Ç–æ—á–∫—É(–∏) –≤ –∫–æ–Ω—Ü–µ, —á—Ç–æ–±—ã "460...8." —Å—Ç–∞–ª–æ –≤–∞–ª–∏–¥–Ω—ã–º.
    function normalizeBarcode(raw) {
      let s = String(raw ?? "").trim();
      if (!s) return "";

      // —É–±–∏—Ä–∞–µ–º –ø—Ä–æ–±–µ–ª—ã/—Ç–∞–±—É–ª—è—Ü–∏–∏ –≤–Ω—É—Ç—Ä–∏
      s = s.replace(/\s+/g, "");

      // NEW: —É–±–∏—Ä–∞–µ–º –æ–¥–Ω—É –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ç–æ—á–µ–∫ –Ω–∞ –∫–æ–Ω—Ü–µ
      while (s.endsWith(".")) s = s.slice(0, -1);

      // —á–∏—Å—Ç–æ —Ü–∏—Ñ—Ä–æ–≤–æ–π
      if (/^\d+$/.test(s)) return s;

      // —á–∞—Å—Ç—ã–π excel-—Å–ª—É—á–∞–π "12345.0"
      if (/^\d+\.0$/.test(s)) return s.split(".0")[0];

      // –¥–æ–ø—É—Å—Ç–∏–º "1,23E12" –∏–ª–∏ "1.23e+12"
      const normalized = s.replace(",", ".");
      const m = normalized.match(/^(\d+)(?:\.(\d+))?e\+?(\d+)$/i);
      if (!m) return "";

      const intPart = m[1];
      const fracPart = m[2] || "";
      const exp = parseInt(m[3], 10);

      const digits = intPart + fracPart;               // –≤—Å–µ —Ü–∏—Ñ—Ä—ã –±–µ–∑ —Ç–æ—á–∫–∏
      const shift = exp - fracPart.length;             // —Å–∫–æ–ª—å–∫–æ –Ω—É–ª–µ–π –Ω–∞–¥–æ –¥–æ–±–∞–≤–∏—Ç—å —Å–ø—Ä–∞–≤–∞ (–µ—Å–ª–∏ >=0)

      if (shift >= 0) {
        return digits + "0".repeat(shift);
      }

      // –ï—Å–ª–∏ shift < 0 ‚Äî —á–∏—Å–ª–æ –±—ã–ª–æ –Ω–µ—Ü–µ–ª—ã–º –ø–æ—Å–ª–µ —Ä–∞–∑–≤—ë—Ä—Ç–∫–∏. –†–∞–∑—Ä–µ—à–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ "—Ö–≤–æ—Å—Ç" ‚Äî –Ω—É–ª–∏.
      const cut = digits.length + shift;               // shift –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π
      if (cut <= 0) return "";

      const tail = digits.slice(cut);
      if (!/^0+$/.test(tail)) return "";

      return digits.slice(0, cut);
    }

    function findBarcodeColumnIndex(selectedIndices) {
      for (const colIndex of selectedIndices) {
        const userName = selectedColumns.get(colIndex) || "";
        const n = normalizeHeaderName(userName);

        if (!n) continue;
        if (/—à—Ç—Ä–∏—Ö–∫–æ–¥/.test(n) || /barcode/.test(n) || /\bean\b/.test(n) || /ean13/.test(n) || /ean 13/.test(n)) {
          return colIndex;
        }
      }
      return -1;
    }

    function buildCsvAndSkipped() {
      if (selectedColumns.size === 0) return { ok: false, error: "–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–ª–æ–Ω–∫–∏." };

      const selectedIndices = Array.from(selectedColumns.keys()).sort((a,b) => a - b);

      const barcodeColIndex = findBarcodeColumnIndex(selectedIndices);
      if (barcodeColIndex === -1) {
        return { ok: false, error: "–ù–µ –Ω–∞–π–¥–µ–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞ —à—Ç—Ä–∏—Ö–∫–æ–¥–∞ —Å—Ä–µ–¥–∏ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö (–Ω–∞–∑–≤–∞–Ω–∏–µ –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å ¬´—à—Ç—Ä–∏—Ö–∫–æ–¥¬ª/barcode/ean)." };
      }

      // BOM –¥–ª—è Excel + UTF-8
      let csvContent = "\uFEFF";

      // Header row
      csvContent += selectedIndices.map(i => escapeCSV(selectedColumns.get(i) || "")).join(",") + "\n";

      const skipped = [];

      for (let rowIndex = startRowIndex; rowIndex < tableData.length; rowIndex++) {
        const row = tableData[rowIndex] || [];

        const rawBarcode = row[barcodeColIndex];
        const rawBarcodeStr = (rawBarcode === undefined || rawBarcode === null) ? "" : String(rawBarcode);

        const normalizedBarcode = normalizeBarcode(rawBarcode);

        if (!normalizedBarcode || !/^\d+$/.test(normalizedBarcode)) {
          const isEmpty = !rawBarcodeStr.trim();
          skipped.push({
            rowIndex,
            rowNumber: rowIndex + 1, // –∫–∞–∫ –≤ Excel
            rawBarcode: rawBarcodeStr,
            normalizedBarcode: normalizedBarcode || "",
            reason: isEmpty ? "–ü—É—Å—Ç–æ–π —à—Ç—Ä–∏—Ö–∫–æ–¥" : "–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —à—Ç—Ä–∏—Ö–∫–æ–¥"
          });
          continue;
        }

        const values = selectedIndices.map(colIndex => {
          if (colIndex === barcodeColIndex) return normalizedBarcode;

          let value = (row[colIndex] !== undefined && row[colIndex] !== null) ? row[colIndex] : "";
          value = String(value).trim();

          // "1349,00" -> "1349.00"
          if (/^\d+,\d{2}$/.test(value)) value = value.replace(",", ".");

          return value;
        });

        // –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ (–ø–æ—Å–ª–µ —Å—Ç–∞—Ä—Ç–∞)
        if (values.every(v => !String(v).trim())) continue;

        csvContent += values.map(v => escapeCSV(v)).join(",") + "\n";
      }

      return { ok: true, csvContent, skipped, skippedCount: skipped.length };
    }

    // --- Saving helpers ---
    function _pickerTypes(filename) {
      const n = String(filename).toLowerCase();
      if (n.endsWith(".html") || n.endsWith(".htm"))
        return [{ description: "HTML-—Ñ–∞–π–ª", accept: { "text/html": [".html"] } }];
      if (n.endsWith(".csv"))
        return [{ description: "CSV-—Ñ–∞–π–ª", accept: { "text/csv": [".csv"] } }];
      return [{ description: "–¢–µ–∫—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª", accept: { "text/plain": [".txt"] } }];
    }

    async function saveTextFile(filename, text, mime) {
      if ("showSaveFilePicker" in window) {
        try {
          const handle = await window.showSaveFilePicker({
            suggestedName: filename,
            types: _pickerTypes(filename)
          });
          const writable = await handle.createWritable();
          await writable.write(new Blob([text], { type: mime || "text/plain;charset=utf-8" }));
          await writable.close();
          return true;
        } catch (e) {
          return false;
        }
      }
      const blob = new Blob([text], { type: mime || "text/plain;charset=utf-8" });
      const link = document.createElement("a");
      const url = URL.createObjectURL(blob);
      link.href = url; link.download = filename;
      document.body.appendChild(link); link.click();
      document.body.removeChild(link); URL.revokeObjectURL(url);
      return true;
    }

    function downloadTextFile(filename, text, mime) { saveTextFile(filename, text, mime); }

    // --- Skipped modal ---
    function openSkippedModal(skipped, fileName) {
      pendingSkippedRows = skipped.slice();
      pendingCsvFileName = fileName || (originalFileName + ".csv");

      // NEW: –≤ –ø—Ä–µ–≤—å—é-–æ–∫–Ω–µ –ù–ï –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç—Ä–æ–∫–∏ —Å –ø—Ä–∏—á–∏–Ω–æ–π "–ü—É—Å—Ç–æ–π —à—Ç—Ä–∏—Ö–∫–æ–¥"
      const filteredForPreview = skipped.filter(s => s.reason !== "–ü—É—Å—Ç–æ–π —à—Ç—Ä–∏—Ö–∫–æ–¥");

      const hiddenCount = skipped.length - filteredForPreview.length;
      const maxShow = 500;
      const toShow = filteredForPreview.slice(0, maxShow);

      skippedSummary.textContent =
        `–í—Å–µ–≥–æ –ø—Ä–æ–ø—É—Å–∫–æ–≤: ${skipped.length}. –°–∫—Ä—ã—Ç–æ –ø—É—Å—Ç—ã—Ö: ${hiddenCount}. –ü–æ–∫–∞–∑–∞–Ω–æ: ${toShow.length}` +
        (filteredForPreview.length > maxShow ? ` (–∏–∑ ${filteredForPreview.length})` : "") + ".";

      let html = "<thead><tr>" +
        '<th style="min-width:90px;">–°—Ç—Ä–æ–∫–∞</th>' +
        '<th style="min-width:240px;">–®—Ç—Ä–∏—Ö–∫–æ–¥ (–∫–∞–∫ –≤ —Ñ–∞–π–ª–µ)</th>' +
        '<th style="min-width:240px;">–ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π</th>' +
        '<th style="min-width:260px;">–ü—Ä–∏—á–∏–Ω–∞</th>' +
        "</tr></thead><tbody>";

      toShow.forEach(s => {
        html += "<tr>" +
          `<td>${escapeHtml(s.rowNumber)}</td>` +
          `<td>${escapeHtml(s.rawBarcode)}</td>` +
          `<td>${escapeHtml(s.normalizedBarcode)}</td>` +
          `<td>${escapeHtml(s.reason)}</td>` +
          "</tr>";
      });

      html += "</tbody>";
      skippedTable.innerHTML = html;

      skippedModal.style.display = "flex";
    }

    function hideSkippedModal() { skippedModal.style.display = "none"; }

    closeSkippedModal.addEventListener("click", hideSkippedModal);
    skippedModal.addEventListener("click", function(e) {
      if (e.target === skippedModal) hideSkippedModal();
    });

    confirmDownloadCsvBtn.addEventListener("click", async function() {
      if (!pendingCsvContent) return;
      await saveTextFile(pendingCsvFileName || (originalFileName + ".csv"), pendingCsvContent, "text/csv;charset=utf-8");
      hideSkippedModal();
    });

    downloadSkippedBtn.addEventListener("click", async function() {
      if (!pendingSkippedRows || pendingSkippedRows.length === 0) {
        alert("–ù–µ—Ç –ø—Ä–æ–ø—É—Å–∫–æ–≤.");
        return;
      }

      let content = "rowNumber,rawBarcode,normalizedBarcode,reason\n";
      pendingSkippedRows.forEach(s => {
        const row = [s.rowNumber, s.rawBarcode, s.normalizedBarcode, s.reason].map(escapeCSV).join(",");
        content += row + "\n";
      });

      await saveTextFile(originalFileName + "_skipped-rows.csv", content, "text/csv;charset=utf-8");
    });

    // --- Main actions ---
    downloadBtn.addEventListener("click", async function() {
      const res = buildCsvAndSkipped();
      if (!res.ok) { alert(res.error); return; }

      pendingCsvContent = res.csvContent;

      // NEW: –º–æ–¥–∞–ª–∫—É –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–æ–ø—É—Å–∫–∏ –ù–ï –∏–∑-–∑–∞ –ø—É—Å—Ç–æ–≥–æ —à—Ç—Ä–∏—Ö–∫–æ–¥–∞
      const skippedForPreview = res.skipped.filter(s => s.reason !== "–ü—É—Å—Ç–æ–π —à—Ç—Ä–∏—Ö–∫–æ–¥");
      if (skippedForPreview.length > 0) {
        openSkippedModal(res.skipped, originalFileName + ".csv");
        return;
      }

      await saveTextFile(originalFileName + ".csv", res.csvContent, "text/csv;charset=utf-8");
    });

    resetBtn.addEventListener("click", function() {
      selectedColumns.clear();
      startRowIndex = 0;
      renderTable();
    });

    // --- Templates modal ---
    function renderSynonymsPanel(panel, tplName) {
      panel.innerHTML = "";
      const synonyms = columnSynonyms[tplName] || [];
      const lbl = document.createElement("div"); lbl.className = "synonyms-label";
      lbl.textContent = "–°–∏–Ω–æ–Ω–∏–º—ã (—Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ, –±–µ–∑ —É—á—ë—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞):"; panel.appendChild(lbl);
      const chipsRow = document.createElement("div"); chipsRow.className = "synonyms-chips";
      synonyms.forEach((syn, i) => {
        const chip = document.createElement("div"); chip.className = "synonym-chip";
        const sinput = document.createElement("input"); sinput.type="text"; sinput.value=syn;
        sinput.className="synonym-input"; sinput.title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–∏–Ω–æ–Ω–∏–º";
        sinput.addEventListener("change", function() {
          if (!columnSynonyms[tplName]) columnSynonyms[tplName]=[];
          columnSynonyms[tplName][i]=sinput.value.trim(); persistAll();
        });
        const rb = document.createElement("button"); rb.className="synonym-remove"; rb.textContent="√ó"; rb.title="–£–¥–∞–ª–∏—Ç—å";
        rb.addEventListener("click", function() {
          if (!columnSynonyms[tplName]) return;
          columnSynonyms[tplName].splice(i,1); persistAll(); renderSynonymsPanel(panel,tplName);
        });
        chip.appendChild(sinput); chip.appendChild(rb); chipsRow.appendChild(chip);
      });
      panel.appendChild(chipsRow);
      const addRow = document.createElement("div"); addRow.className="synonym-add-row";
      const addInput = document.createElement("input"); addInput.type="text";
      addInput.placeholder="–ù–æ–≤—ã–π —Å–∏–Ω–æ–Ω–∏–º‚Ä¶"; addInput.className="synonym-new-input";
      const addBtn = document.createElement("button"); addBtn.className="btn-primary";
      addBtn.style.cssText="font-size:12px;padding:5px 10px"; addBtn.textContent="+ –î–æ–±–∞–≤–∏—Ç—å";
      addBtn.addEventListener("click", function() {
        const val = addInput.value.trim(); if (!val) return;
        if (!columnSynonyms[tplName]) columnSynonyms[tplName]=[];
        columnSynonyms[tplName].push(val); persistAll(); addInput.value=""; renderSynonymsPanel(panel,tplName);
      });
      addInput.addEventListener("keydown", e => { if (e.key==="Enter") addBtn.click(); });
      addRow.appendChild(addInput); addRow.appendChild(addBtn); panel.appendChild(addRow);
    }

    function renderTemplatesList() {
      templatesList.innerHTML = "";
      const total = columnTemplates.length;
      columnTemplates.forEach((t, idx) => {
        const block = document.createElement("div"); block.className="template-block";
        const row = document.createElement("div"); row.className="template-row";
        const upBtn = document.createElement("button"); upBtn.className="btn-secondary btn-icon";
        upBtn.textContent="‚Üë"; upBtn.title="–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤–≤–µ—Ä—Ö"; upBtn.disabled = idx===0;
        upBtn.addEventListener("click", function() {
          if (idx===0) return;
          [columnTemplates[idx-1],columnTemplates[idx]]=[columnTemplates[idx],columnTemplates[idx-1]];
          persistAll(); renderTemplatesList(); renderTable();
        });
        const downBtn = document.createElement("button"); downBtn.className="btn-secondary btn-icon";
        downBtn.textContent="‚Üì"; downBtn.title="–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤–Ω–∏–∑"; downBtn.disabled = idx===total-1;
        downBtn.addEventListener("click", function() {
          if (idx===total-1) return;
          [columnTemplates[idx],columnTemplates[idx+1]]=[columnTemplates[idx+1],columnTemplates[idx]];
          persistAll(); renderTemplatesList(); renderTable();
        });
        const input = document.createElement("input"); input.type="text"; input.value=t;
        const capturedOld = t;
        input.addEventListener("change", function() {
          const newName = input.value.trim();
          if (!newName || newName===capturedOld) return;
          if (columnSynonyms[capturedOld]!==undefined) { columnSynonyms[newName]=columnSynonyms[capturedOld]; delete columnSynonyms[capturedOld]; }
          columnTemplates[idx]=newName; persistAll(); renderTemplatesList(); renderTable();
        });
        const synToggle = document.createElement("button"); synToggle.className="btn-secondary syn-toggle-btn";
        synToggle.textContent="üî§ –°–∏–Ω–æ–Ω–∏–º—ã"; synToggle.title="–ü–æ–∫–∞–∑–∞—Ç—å / —Å–∫—Ä—ã—Ç—å —Å–∏–Ω–æ–Ω–∏–º—ã";
        synToggle.addEventListener("click", function() {
          const p = block.querySelector(".synonyms-panel");
          if (!p) return;
          const shown = p.style.display!=="none";
          p.style.display = shown ? "none" : "block";
          synToggle.textContent = shown ? "üî§ –°–∏–Ω–æ–Ω–∏–º—ã" : "üî§ –°–∏–Ω–æ–Ω–∏–º—ã ‚ñ≤";
        });
        const delBtn = document.createElement("button"); delBtn.className="btn-secondary"; delBtn.textContent="–£–¥–∞–ª–∏—Ç—å";
        delBtn.addEventListener("click", function() {
          columnTemplates.splice(idx,1); persistAll(); renderTemplatesList(); renderTable();
        });
        row.appendChild(upBtn); row.appendChild(downBtn); row.appendChild(input);
        row.appendChild(synToggle); row.appendChild(delBtn); block.appendChild(row);
        const synPanel = document.createElement("div"); synPanel.className="synonyms-panel"; synPanel.style.display="none";
        renderSynonymsPanel(synPanel, t); block.appendChild(synPanel);
        templatesList.appendChild(block);
      });
    }
    function openTemplatesModal() {
      renderTemplatesList();
      templatesModal.style.display = "flex";
      newTemplateInput.value = "";
      newTemplateInput.focus();
    }
    function hideTemplatesModal() { templatesModal.style.display = "none"; }

    manageTemplatesBtn.addEventListener("click", function(e) {
      e.stopPropagation();
      openTemplatesModal();
    });
    closeTemplatesModal.addEventListener("click", hideTemplatesModal);
    templatesModal.addEventListener("click", function(e) {
      if (e.target === templatesModal) hideTemplatesModal();
    });

    addTemplateBtn.addEventListener("click", function() {
      const val = newTemplateInput.value.trim();
      if (!val) return;
      columnTemplates.push(val);
      persistAll();
      renderTemplatesList();
      renderTable();
      newTemplateInput.value = "";
      newTemplateInput.focus();
    });
    newTemplateInput.addEventListener("keydown", function(e) {
      if (e.key === "Enter") addTemplateBtn.click();
    });

    // --- Save app (export HTML without table data) ---
    function buildExportHtml() {
      persistColumnTemplates();

      const clone = document.documentElement.cloneNode(true);

      // remove table data
      const clonedTable = clone.querySelector("#dataTable");
      if (clonedTable) clonedTable.innerHTML = "";

      const uploadScreenClone = clone.querySelector("#uploadScreen");
      const tableContainerClone = clone.querySelector("#tableContainer");
      if (uploadScreenClone) uploadScreenClone.style.display = "flex";
      if (tableContainerClone) tableContainerClone.style.display = "none";

      const dl = clone.querySelector("#downloadBtn");
      if (dl) dl.disabled = true;

      const loadMoreContainerClone = clone.querySelector("#loadMoreContainer");
      if (loadMoreContainerClone) loadMoreContainerClone.style.display = "none";

      ["totalColumns", "selectedColumns", "totalRows", "remainingRows"].forEach(id => {
        const el = clone.querySelector("#" + id);
        if (el) el.textContent = "0";
      });

      clone.querySelectorAll(".dropdown.show").forEach(d => d.classList.remove("show"));

      const modal1 = clone.querySelector("#templatesModal");
      if (modal1) modal1.style.display = "none";
      const modal2 = clone.querySelector("#skippedModal");
      if (modal2) modal2.style.display = "none";

      return "<!DOCTYPE html>\n" + clone.outerHTML;
    }

    saveAppBtn.addEventListener("click", async function() {
      const html = buildExportHtml();
      await saveTextFile("index.html", html, "text/html;charset=utf-8");
    });
  </script>
<script>
(function(){
  const href = location.href;
  document.querySelectorAll('.global-nav__link').forEach(a => {
    const m = a.getAttribute('data-match') || '';
    if (m && href.includes(m)) a.classList.add('is-active');
    // –∑–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç: –µ—Å–ª–∏ —Å–æ–≤–ø–∞–¥–∞–µ—Ç –¥–æ–º+–ø—É—Ç—å —Ü–µ–ª–∏–∫–æ–º
    if (!m && href.startsWith(a.href)) a.classList.add('is-active');
  });
})();
</script>




</body></html>
