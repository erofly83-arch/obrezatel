<!DOCTYPE html>
<html lang="ru"><head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Table to CSV</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/exceljs@4.3.0/dist/exceljs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <!-- –ö–æ–Ω—Ñ–∏–≥, –∫–æ—Ç–æ—Ä—ã–π –≤—à–∏–≤–∞–µ—Ç—Å—è –≤ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å" -->
  <script id="userConfig" type="application/json">{
  "columnTemplates": [
    "–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ",
    "–¶–µ–Ω–∞",
    "–®—Ç—Ä–∏—Ö–∫–æ–¥",
    "–¶–µ–Ω–∞ –ù–î–°",
    "–¶–µ–Ω–∞ –ù–ê–õ",
    "–û—Å—Ç–∞—Ç–æ–∫"
  ]
}</script>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
      background: #f0f0f0;
      min-height: 100vh;
      color: #333;
    }

    .upload-screen {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
    }
    .upload-card {
      background: white;
      border-radius: 12px;
      padding: 40px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      text-align: center;
      max-width: 440px;
      width: 100%;
    }
    .upload-card h1 { font-size: 22px; margin-bottom: 18px; font-weight: 650; }
    input[type="file"] { display: none; }
    .upload-btn {
      display: inline-block;
      padding: 12px 28px;
      background: #0078D4;
      color: #fff;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      border: none;
      user-select: none;
      transition: background .15s;
    }
    .upload-btn:hover { background: #106EBE; }

    .container {
      display: none;
      padding: 16px;
      max-width: 1600px;
      margin: 0 auto;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 10px;
      padding: 10px 12px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .header h1 { font-size: 16px; font-weight: 700; }
    .file-input-wrapper { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }

    .hint {
      font-size: 12px;
      color: #555;
      margin-bottom: 10px;
      padding: 10px 12px;
      background: #fff4ce;
      border-radius: 6px;
      border-left: 3px solid #ffb900;
      line-height: 1.35;
    }

    .info-bar {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
      font-size: 13px;
      margin-bottom: 8px;
    }

    .sheet-selector { display: none; }
    .sheet-selector select {
      padding: 6px 10px;
      border-radius: 6px;
      border: 1px solid #d1d1d1;
      background: #fff;
      font-size: 13px;
    }

    .stats {
      display: inline-flex;
      gap: 14px;
      padding: 6px 10px;
      background: #fff;
      border: 1px solid #d1d1d1;
      border-radius: 6px;
      font-size: 12px;
      align-items: center;
    }
    .stat-item { display: inline-flex; gap: 6px; align-items: center; }
    .stat-item span:first-child { color: #666; }
    .stat-value { font-weight: 700; color: #0078D4; }

    .actions {
      display: flex;
      gap: 8px;
      justify-content: center;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }
    button {
      padding: 8px 18px;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 650;
      cursor: pointer;
      transition: all .15s;
    }
    button:disabled {
      background: #f3f3f3;
      color: #a6a6a6;
      cursor: not-allowed;
      border: 1px solid #d1d1d1;
    }
    .btn-primary { background: #107C10; color: #fff; }
    .btn-primary:hover:not(:disabled) { background: #0e6b0e; }
    .btn-secondary { background: #f3f3f3; color: #333; border: 1px solid #d1d1d1; }
    .btn-secondary:hover { background: #e8e8e8; }

    .table-container {
      background: #fff;
      border: 1px solid #d1d1d1;
      border-radius: 8px;
      overflow: auto;
      max-height: calc(100vh - 230px);
    }
    table { width: 100%; border-collapse: collapse; font-size: 12px; }
    th, td {
      padding: 6px 10px;
      border: 1px solid #d1d1d1;
      min-width: 110px;
      vertical-align: top;
      background: #fff;
    }
    th {
      position: sticky;
      top: 0;
      z-index: 10;
      background: #f2f2f2;
      font-weight: 750;
      cursor: pointer;
      user-select: none;
      transition: background .12s;
    }
    th:hover { background: #eaeaea; }
    th.selected { background: #0078D4; color: #fff; }
    td { cursor: pointer; }
    td:hover { background: #f9f9f9; }

    .row-hidden { display: none; }

    .rename-wrapper { position: relative; width: 100%; }
    .rename-input {
      width: 100%;
      padding: 4px 6px;
      border: 1px solid rgba(255,255,255,0.3);
      border-radius: 4px;
      font-size: 12px;
      font-weight: 750;
      color: #fff;
      background: rgba(255,255,255,0.15);
      outline: none;
    }
    .rename-input::placeholder { color: rgba(255,255,255,0.75); }
    .rename-input:focus {
      border-color: rgba(255,255,255,0.65);
      background: rgba(255,255,255,0.22);
    }

    .dropdown {
      position: absolute;
      top: calc(100% + 4px);
      left: 0;
      background: #fff;
      border: 1px solid #d1d1d1;
      border-radius: 8px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.15);
      max-height: 320px;
      overflow-y: auto;
      z-index: 1000;
      display: none;
      min-width: 220px;
	  color: #333;
	  text-align: left;
    }
    .dropdown.show { display: block; }
    .dropdown-item {
	color: #333;
      padding: 8px 10px;
      cursor: pointer;
      font-size: 13px;
      white-space: nowrap;
	  text-align: left;
    }
    .dropdown-item:hover { background: #f0f0f0;}

    .load-more-container {
      display: none;
      margin-top: 10px;
      padding: 10px;
      background: #fff;
      border: 1px solid #d1d1d1;
      border-radius: 8px;
      text-align: center;
    }
    .btn-load-more {
      background: #0078D4;
      color: #fff;
      width: 100%;
    }
    .btn-load-more:hover { background: #106EBE; }

    /* Modal */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.35);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      padding: 14px;
    }
    .modal-content {
      width: min(980px, 96vw);
      background: #fff;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 12px 35px rgba(0,0,0,0.25);
    }
    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 12px 14px;
      border-bottom: 1px solid #e6e6e6;
      font-weight: 800;
    }
    .modal-body { padding: 14px; }
    .muted { color: #666; font-size: 12px; line-height: 1.35; }

    .template-add { display: flex; gap: 8px; margin-bottom: 10px; }
    .template-add input {
      flex: 1;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #d1d1d1;
      font-size: 13px;
    }
    .template-row { display: flex; gap: 8px; margin: 6px 0; }
    .template-row input {
      flex: 1;
      padding: 7px 10px;
      border-radius: 8px;
      border: 1px solid #d1d1d1;
      font-size: 13px;
    }

    .skipped-wrap {
      border: 1px solid #d1d1d1;
      border-radius: 10px;
      overflow: auto;
      max-height: 55vh;
      background: #fff;
      margin-top: 10px;
    }
    .skipped-table th { position: sticky; top: 0; z-index: 2; cursor: default; }
    .skipped-actions {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
      flex-wrap: wrap;
      margin-top: 10px;
    }
  </style>
</head>

<body>
<!-- –ù–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω–∞—è –ø–∞–Ω–µ–ª—å -->
<style>
.app-navigation {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    padding: 0;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    position: sticky;
    top: 0;
    z-index: 1000;
}

.nav-container {
    max-width: 1400px;
    margin: 0 auto;
    display: flex;
    gap: 0;
}

.nav-tab {
    flex: 1;
    padding: 15px 20px;
    text-align: center;
    text-decoration: none;
    color: rgba(255,255,255,0.8);
    font-weight: 500;
    font-size: 16px;
    transition: all 0.3s ease;
    border-bottom: 3px solid transparent;
    background: transparent;
}

.nav-tab:hover {
    background: rgba(255,255,255,0.1);
    color: white;
}

.nav-tab.active {
    color: white;
    border-bottom-color: white;
    background: rgba(255,255,255,0.15);
}

@media (max-width: 768px) {
    .nav-tab {
        padding: 12px 10px;
        font-size: 14px;
    }
}
</style>

<nav class="app-navigation">
    <div class="nav-container">
        <a href="https://erofly83-arch.github.io/pricematcher/" class="nav-tab" id="nav-matcher">üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ü–µ–Ω</a>
        <a href="https://erofly83-arch.github.io/obrezatel/" class="nav-tab" id="nav-cutter">üìã –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–∞–±–ª–∏—Ü</a>
        <a href="https://erofly83-arch.github.io/synonyms/" class="nav-tab" id="nav-sinonims">üîó –°–∏–Ω–æ–Ω–∏–º—ã</a>
    </div>
</nav>

<script>
// –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –≤–∫–ª–∞–¥–∫—É
(function() {
    const currentPage = 'cutter';
    const activeTab = document.getElementById('nav-' + currentPage);
    if (activeTab) {
        activeTab.classList.add('active');
    }
})();
</script>

  <!-- Upload -->
  <div class="upload-screen" id="uploadScreen" style="display: flex;">
    <div class="upload-card">
      <h1>üìä Table to CSV</h1>
      <input type="file" id="fileInput" accept=".xlsx,.xls,.xlsb,.xlsm,.xml,.csv,.ods,.fods,.txt,.dbf,.dif,.sylk,.prn">
      <label for="fileInput" class="upload-btn">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª</label>
    </div>
  </div>

  <!-- Main -->
  <div class="container" id="tableContainer" style="display: none;">
    <div class="header">
      <h1>üìä Table to CSV</h1>

      <div class="file-input-wrapper">
        <input type="file" id="fileInput2" accept=".xlsx,.xls,.xlsb,.xlsm,.xml,.csv,.ods,.fods,.txt,.dbf,.dif,.sylk,.prn">
        <label for="fileInput2" class="upload-btn" style="padding: 6px 14px; font-size: 13px;">–ó–∞–≥—Ä—É–∑–∏—Ç—å –¥—Ä—É–≥–æ–π —Ñ–∞–π–ª</label>

        <div class="sheet-selector" id="sheetSelector" style="display: none;">
          <select id="sheetSelect"></select>
        </div>
      </div>
    </div>

    <div class="hint">
      <strong>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:</strong> –ö–ª–∏–∫ –ø–æ –∑–∞–≥–æ–ª–æ–≤–∫—É –≤—ã–±–∏—Ä–∞–µ—Ç –∫–æ–ª–æ–Ω–∫—É –∏ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç —Å–ø–∏—Å–æ–∫ ‚Üí –º–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –∏–ª–∏ –≤–≤–µ—Å—Ç–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –≤—Ä—É—á–Ω—É—é ‚Üí –∫–ª–∏–∫ –ø–æ —Å—Ç—Ä–æ–∫–µ —Å–∫—Ä—ã–≤–∞–µ—Ç –≤—Å–µ —Å—Ç—Ä–æ–∫–∏ –≤—ã—à–µ.
    </div>

    <div class="info-bar">
      <div class="stats">
        <div class="stat-item"><span>–ö–æ–ª–æ–Ω–æ–∫:</span><span class="stat-value" id="totalColumns">0</span></div>
        <div class="stat-item"><span>–í—ã–±—Ä–∞–Ω–æ:</span><span class="stat-value" id="selectedColumns">0</span></div>
        <div class="stat-item"><span>–°—Ç—Ä–æ–∫:</span><span class="stat-value" id="totalRows">0</span></div>
      </div>
    </div>

    <div class="actions">
      <button class="btn-primary" id="downloadBtn" disabled="">‚¨áÔ∏è –°–∫–∞—á–∞—Ç—å CSV</button>
      <button class="btn-secondary" id="resetBtn">üîÑ –°–±—Ä–æ—Å–∏—Ç—å</button>
      <button class="btn-secondary" id="manageTemplatesBtn">üìù –ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è</button>
      <button class="btn-secondary" id="saveAppBtn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>

    <div class="table-container">
      <table id="dataTable"></table>
    </div>

    <div class="load-more-container" id="loadMoreContainer" style="display: none;">
      <button class="btn-load-more" id="loadMoreBtn">–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ —Å—Ç—Ä–æ–∫–∏ (<span id="remainingRows">0</span>)</button>
    </div>
  </div>

  <!-- Templates modal -->
  <div class="modal" id="templatesModal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <div>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è –∫–æ–ª–æ–Ω–æ–∫</div>
        <button class="btn-secondary" id="closeTemplatesModal">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
      <div class="modal-body">
        <div class="template-add">
          <input id="newTemplateInput" type="text" placeholder="–î–æ–±–∞–≤–∏—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä: –®—Ç—Ä–∏—Ö–∫–æ–¥)">
          <button class="btn-primary" id="addTemplateBtn">–î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
        <div id="templatesList"><div class="template-row"><input type="text"><button class="btn-secondary">–£–¥–∞–ª–∏—Ç—å</button></div><div class="template-row"><input type="text"><button class="btn-secondary">–£–¥–∞–ª–∏—Ç—å</button></div><div class="template-row"><input type="text"><button class="btn-secondary">–£–¥–∞–ª–∏—Ç—å</button></div><div class="template-row"><input type="text"><button class="btn-secondary">–£–¥–∞–ª–∏—Ç—å</button></div><div class="template-row"><input type="text"><button class="btn-secondary">–£–¥–∞–ª–∏—Ç—å</button></div><div class="template-row"><input type="text"><button class="btn-secondary">–£–¥–∞–ª–∏—Ç—å</button></div></div>
        <div class="hint" style="margin-top: 10px;">
          –ò–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ–ø–∞–¥—É—Ç –≤ –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ –∏ —Å–æ—Ö—Ä–∞–Ω—è—Ç—Å—è –≤ —Ñ–∞–π–ª –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ ¬´–°–æ—Ö—Ä–∞–Ω–∏—Ç—å¬ª.
        </div>
      </div>
    </div>
  </div>

  <!-- Skipped modal -->
  <div class="modal" id="skippedModal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <div>–ü—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏</div>
        <button class="btn-secondary" id="closeSkippedModal">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
      <div class="modal-body">
        <div id="skippedSummary" class="muted"></div>

        <div class="skipped-wrap">
          <table class="skipped-table" id="skippedTable"></table>
        </div>

        <div class="skipped-actions">
          <button class="btn-secondary" id="downloadSkippedBtn">‚¨áÔ∏è –°–∫–∞—á–∞—Ç—å —Å–ø–∏—Å–æ–∫ –ø—Ä–æ–ø—É—Å–∫–æ–≤</button>
          <button class="btn-primary" id="confirmDownloadCsvBtn">‚¨áÔ∏è –°–∫–∞—á–∞—Ç—å CSV</button>
        </div>

        <div class="muted" style="margin-top: 8px;">
          –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: CSV –±—É–¥–µ—Ç —Å–∫–∞—á–∞–Ω –¥–∞–∂–µ –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –ø—Ä–æ–ø—É—Å–∫–æ–≤. –í—ã –º–æ–∂–µ—Ç–µ –∑–∞–∫—Ä—ã—Ç—å —ç—Ç–æ –æ–∫–Ω–æ, –∏—Å–ø—Ä–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ/–≤—ã–±–æ—Ä –∫–æ–ª–æ–Ω–æ–∫ –∏ —Å–∫–∞—á–∞—Ç—å —Å–Ω–æ–≤–∞.
        </div>
      </div>
    </div>
  </div>

  <script>
    // --- Editable templates ---
    const DEFAULT_COLUMN_TEMPLATES = [
      "–®—Ç—Ä–∏—Ö–∫–æ–¥",
      "EAN",
      "–ê—Ä—Ç–∏–∫—É–ª",
      "–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ",
      "–ë—Ä–µ–Ω–¥",
      "–ö–∞—Ç–µ–≥–æ—Ä–∏—è",
      "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ",
      "–¶–µ–Ω–∞",
      "–°—É–º–º–∞",
      "–°–∫–ª–∞–¥",
      "300..",
      "750.."
    ];

    function getUserConfig() {
      const el = document.getElementById("userConfig");
      if (!el) return {};
      try { return JSON.parse(el.textContent || "{}"); } catch { return {}; }
    }
    function setUserConfig(cfg) {
      const el = document.getElementById("userConfig");
      if (!el) return;
      el.textContent = JSON.stringify(cfg, null, 2);
    }

    function loadColumnTemplates() {
      const cfg = getUserConfig();
      if (Array.isArray(cfg.columnTemplates) && cfg.columnTemplates.length) return cfg.columnTemplates;

      const raw = localStorage.getItem("columnTemplates");
      if (raw) {
        try {
          const arr = JSON.parse(raw);
          if (Array.isArray(arr) && arr.length) return arr;
        } catch {}
      }
      return DEFAULT_COLUMN_TEMPLATES.slice();
    }

    function persistColumnTemplates() {
      const cfg = getUserConfig();
      cfg.columnTemplates = columnTemplates.slice();
      setUserConfig(cfg);
      localStorage.setItem("columnTemplates", JSON.stringify(columnTemplates));
    }

    let columnTemplates = loadColumnTemplates();
    persistColumnTemplates();

    // --- App state ---
    let tableData = null;
    let selectedColumns = new Map(); // colIndex -> userName
    let startRowIndex = 0;
    let currentWorkbook = null;
    let displayedRows = 50;
    let activeDropdown = null;
    let originalFileName = "export";

    // download-pending
    let pendingCsvContent = null;
    let pendingCsvFileName = null;
    let pendingSkippedRows = [];

    // --- DOM refs ---
    const uploadScreen = document.getElementById("uploadScreen");
    const fileInput = document.getElementById("fileInput");
    const fileInput2 = document.getElementById("fileInput2");
    const tableContainer = document.getElementById("tableContainer");
    const dataTable = document.getElementById("dataTable");

    const downloadBtn = document.getElementById("downloadBtn");
    const resetBtn = document.getElementById("resetBtn");
    const manageTemplatesBtn = document.getElementById("manageTemplatesBtn");
    const saveAppBtn = document.getElementById("saveAppBtn");

    const sheetSelector = document.getElementById("sheetSelector");
    const sheetSelect = document.getElementById("sheetSelect");

    const loadMoreBtn = document.getElementById("loadMoreBtn");
    const loadMoreContainer = document.getElementById("loadMoreContainer");

    const templatesModal = document.getElementById("templatesModal");
    const closeTemplatesModal = document.getElementById("closeTemplatesModal");
    const newTemplateInput = document.getElementById("newTemplateInput");
    const addTemplateBtn = document.getElementById("addTemplateBtn");
    const templatesList = document.getElementById("templatesList");

    const skippedModal = document.getElementById("skippedModal");
    const closeSkippedModal = document.getElementById("closeSkippedModal");
    const skippedSummary = document.getElementById("skippedSummary");
    const skippedTable = document.getElementById("skippedTable");
    const confirmDownloadCsvBtn = document.getElementById("confirmDownloadCsvBtn");
    const downloadSkippedBtn = document.getElementById("downloadSkippedBtn");

    // Close dropdown on outside click
    document.addEventListener("click", function(e) {
      const inRename = !!e.target.closest(".rename-wrapper");
      const inModal = !!e.target.closest(".modal-content");
      if (!inRename && !inModal && activeDropdown) {
        activeDropdown.classList.remove("show");
        activeDropdown = null;
      }
    });

    // --- File load ---
    fileInput.addEventListener("change", handleFileUpload);
    fileInput2.addEventListener("change", handleFileUpload);

    function handleFileUpload(event) {
      const file = event.target.files && event.target.files[0];
      if (!file) return;

      originalFileName = (file.name || "export").replace(/\.[^.]+$/, "");

      const reader = new FileReader();
      reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        try {
          currentWorkbook = XLSX.read(data, { type: "array" });

          if (currentWorkbook.SheetNames.length > 1) {
            sheetSelect.innerHTML = "";
            currentWorkbook.SheetNames.forEach((name, index) => {
              const option = document.createElement("option");
              option.value = String(index);
              option.textContent = name;
              sheetSelect.appendChild(option);
            });
            sheetSelector.style.display = "block";
          } else {
            sheetSelector.style.display = "none";
          }

          loadSheet(0);
          uploadScreen.style.display = "none";
          tableContainer.style.display = "block";
        } catch (err) {
          alert(err && err.message ? err.message : String(err));
          console.error(err);
        }
      };
      reader.readAsArrayBuffer(file);
    }

    sheetSelect.addEventListener("change", function() {
      const idx = parseInt(sheetSelect.value, 10) || 0;
      loadSheet(idx);
    });

    function loadSheet(sheetIndex) {
      if (!currentWorkbook) return;
      const sheetName = currentWorkbook.SheetNames[sheetIndex];
      const worksheet = currentWorkbook.Sheets[sheetName];
      const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: "", raw: true });

      tableData = jsonData;
      startRowIndex = 0;
      selectedColumns.clear();
      displayedRows = Math.min(50, tableData.length);

      renderTable();
      updateLoadMoreButton();
    }

    // --- Render ---
    function escapeHtml(text) {
      return String(text)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function renderTable() {
      if (!tableData || tableData.length === 0) {
        dataTable.innerHTML = "<tr><td>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>";
        updateStats();
        return;
      }

      const maxCols = Math.max(0, ...tableData.map(r => (r ? r.length : 0)));
      const rowsToShow = Math.min(displayedRows, tableData.length);

      let html = "<thead><tr>";
      for (let i = 0; i < maxCols; i++) {
        const isSelected = selectedColumns.has(i);
        const customName = selectedColumns.get(i);
        html += `<th class="${isSelected ? "selected" : ""}" data-col="${i}">`;
        if (isSelected) html += createRenameInput(i, customName);
        else html += escapeHtml(String(i + 1));
        html += "</th>";
      }
      html += "</tr></thead><tbody>";

      for (let rowIndex = 0; rowIndex < rowsToShow; rowIndex++) {
        const row = tableData[rowIndex] || [];
        const isHidden = rowIndex < startRowIndex;
        html += `<tr class="${isHidden ? "row-hidden" : ""}" data-row-index="${rowIndex}">`;
        for (let i = 0; i < maxCols; i++) {
          const cellValue = (row[i] !== undefined && row[i] !== null) ? row[i] : "";
          html += `<td data-row="${rowIndex}" data-col="${i}">${escapeHtml(cellValue)}</td>`;
        }
        html += "</tr>";
      }
      html += "</tbody>";

      dataTable.innerHTML = html;
      attachEventListeners();
      updateStats();
    }

    function createRenameInput(colIndex, value) {
      const escapedValue = String(value || "").replaceAll('"', "&quot;");
      const itemsHtml = columnTemplates
        .filter(Boolean)
        .map(t => {
          const safeText = escapeHtml(t);
          const safeAttr = String(t).replaceAll('"', "&quot;");
          return `<div class="dropdown-item" data-value="${safeAttr}">${safeText}</div>`;
        })
        .join("");

      return `
        <div class="rename-wrapper" data-col="${colIndex}">
          <input type="text" class="rename-input" value="${escapedValue}" data-col="${colIndex}" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ"/>
          <div class="dropdown" data-col="${colIndex}">${itemsHtml}</div>
        </div>
      `;
    }

    function openDropdownForColumn(colIndex, focus = true) {
      const input = document.querySelector(`.rename-input[data-col="${colIndex}"]`);
      const dropdown = document.querySelector(`.dropdown[data-col="${colIndex}"]`);
      if (!input || !dropdown) return;

      if (activeDropdown && activeDropdown !== dropdown) activeDropdown.classList.remove("show");
      dropdown.classList.add("show");
      activeDropdown = dropdown;

      if (focus) {
        input.focus();
        input.select();
      }
    }

    function attachEventListeners() {
      // Header click: select/unselect (ignore input clicks)
      document.querySelectorAll("th").forEach(th => {
        th.addEventListener("click", function(e) {
          if (e.target.closest(".rename-wrapper")) return;
          const colIndex = parseInt(th.dataset.col, 10);

          const wasSelected = selectedColumns.has(colIndex);
          if (wasSelected) {
            selectedColumns.delete(colIndex);
            renderTable();
            return;
          }

          selectedColumns.set(colIndex, "");
          renderTable();
          requestAnimationFrame(() => openDropdownForColumn(colIndex, true));
        });
      });

      // Input events
      document.querySelectorAll(".rename-input").forEach(input => {
        input.addEventListener("click", function(e) {
          e.stopPropagation();
          openDropdownForColumn(parseInt(e.target.dataset.col, 10), false);
        });
        input.addEventListener("input", function(e) {
          const colIndex = parseInt(e.target.dataset.col, 10);
          selectedColumns.set(colIndex, e.target.value);
          updateStats();
        });
        input.addEventListener("focus", function(e) {
          e.target.select();
        });
      });

      // Dropdown pick
      document.querySelectorAll(".dropdown-item").forEach(item => {
        item.addEventListener("click", function(e) {
          e.stopPropagation();
          const value = e.target.dataset.value || "";
          const dropdown = e.target.closest(".dropdown");
          const colIndex = parseInt(dropdown.dataset.col, 10);
          const input = document.querySelector(`.rename-input[data-col="${colIndex}"]`);
          if (!input) return;

          input.value = value;
          selectedColumns.set(colIndex, value);

          dropdown.classList.remove("show");
          activeDropdown = null;

          updateStats();
        });
      });

      // Row click: hide all rows above
      document.querySelectorAll("td").forEach(td => {
        td.addEventListener("click", function() {
          startRowIndex = parseInt(td.dataset.row, 10) || 0;
          renderTable();
        });
      });
    }

    function updateLoadMoreButton() {
      const remaining = (tableData ? tableData.length : 0) - displayedRows;
      if (remaining > 0) {
        loadMoreContainer.style.display = "block";
        document.getElementById("remainingRows").textContent = String(remaining);
      } else {
        loadMoreContainer.style.display = "none";
      }
    }

    loadMoreBtn.addEventListener("click", function() {
      displayedRows = tableData ? tableData.length : displayedRows;
      renderTable();
      updateLoadMoreButton();
    });

    function updateStats() {
      const maxCols = tableData && tableData.length > 0
        ? Math.max(0, ...tableData.map(r => (r ? r.length : 0)))
        : 0;

      document.getElementById("totalColumns").textContent = String(maxCols);
      document.getElementById("selectedColumns").textContent = String(selectedColumns.size);
      document.getElementById("totalRows").textContent = String(Math.max(0, (tableData ? tableData.length : 0) - startRowIndex));

      downloadBtn.disabled = selectedColumns.size === 0;
    }

    // --- CSV helpers ---
    function escapeCSV(value) {
      if (value === null || value === undefined) return "";
      const s = String(value);
      if (s.includes('"') || s.includes(",") || s.includes("\n") || s.includes("\r")) {
        return `"${s.replaceAll('"', '""')}"`;
      }
      return s;
    }

    function normalizeHeaderName(name) {
      return String(name || "")
        .toLowerCase()
        .trim()
        .replaceAll("—ë", "–µ")
        .replaceAll(/\s+/g, " ")
        .replaceAll(/[^\p{L}\p{N} ]/gu, ""); // —É–±–∏—Ä–∞–µ–º –ø—É–Ω–∫—Ç—É–∞—Ü–∏—é (unicode)
    }

    // –í–ê–ñ–ù–û: —Ç–µ–ø–µ—Ä—å —É–¥–∞–ª—è–µ–º —Ç–æ—á–∫—É(–∏) –≤ –∫–æ–Ω—Ü–µ, —á—Ç–æ–±—ã "460...8." —Å—Ç–∞–ª–æ –≤–∞–ª–∏–¥–Ω—ã–º.
    function normalizeBarcode(raw) {
      let s = String(raw ?? "").trim();
      if (!s) return "";

      // —É–±–∏—Ä–∞–µ–º –ø—Ä–æ–±–µ–ª—ã/—Ç–∞–±—É–ª—è—Ü–∏–∏ –≤–Ω—É—Ç—Ä–∏
      s = s.replace(/\s+/g, "");

      // NEW: —É–±–∏—Ä–∞–µ–º –æ–¥–Ω—É –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ç–æ—á–µ–∫ –Ω–∞ –∫–æ–Ω—Ü–µ
      while (s.endsWith(".")) s = s.slice(0, -1);

      // —á–∏—Å—Ç–æ —Ü–∏—Ñ—Ä–æ–≤–æ–π
      if (/^\d+$/.test(s)) return s;

      // —á–∞—Å—Ç—ã–π excel-—Å–ª—É—á–∞–π "12345.0"
      if (/^\d+\.0$/.test(s)) return s.split(".0")[0];

      // –¥–æ–ø—É—Å—Ç–∏–º "1,23E12" –∏–ª–∏ "1.23e+12"
      const normalized = s.replace(",", ".");
      const m = normalized.match(/^(\d+)(?:\.(\d+))?e\+?(\d+)$/i);
      if (!m) return "";

      const intPart = m[1];
      const fracPart = m[2] || "";
      const exp = parseInt(m[3], 10);

      const digits = intPart + fracPart;               // –≤—Å–µ —Ü–∏—Ñ—Ä—ã –±–µ–∑ —Ç–æ—á–∫–∏
      const shift = exp - fracPart.length;             // —Å–∫–æ–ª—å–∫–æ –Ω—É–ª–µ–π –Ω–∞–¥–æ –¥–æ–±–∞–≤–∏—Ç—å —Å–ø—Ä–∞–≤–∞ (–µ—Å–ª–∏ >=0)

      if (shift >= 0) {
        return digits + "0".repeat(shift);
      }

      // –ï—Å–ª–∏ shift < 0 ‚Äî —á–∏—Å–ª–æ –±—ã–ª–æ –Ω–µ—Ü–µ–ª—ã–º –ø–æ—Å–ª–µ —Ä–∞–∑–≤—ë—Ä—Ç–∫–∏. –†–∞–∑—Ä–µ—à–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ "—Ö–≤–æ—Å—Ç" ‚Äî –Ω—É–ª–∏.
      const cut = digits.length + shift;               // shift –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π
      if (cut <= 0) return "";

      const tail = digits.slice(cut);
      if (!/^0+$/.test(tail)) return "";

      return digits.slice(0, cut);
    }

    function findBarcodeColumnIndex(selectedIndices) {
      for (const colIndex of selectedIndices) {
        const userName = selectedColumns.get(colIndex) || "";
        const n = normalizeHeaderName(userName);

        if (!n) continue;
        if (/—à—Ç—Ä–∏—Ö–∫–æ–¥/.test(n) || /barcode/.test(n) || /\bean\b/.test(n) || /ean13/.test(n) || /ean 13/.test(n)) {
          return colIndex;
        }
      }
      return -1;
    }

    function buildCsvAndSkipped() {
      if (selectedColumns.size === 0) return { ok: false, error: "–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–ª–æ–Ω–∫–∏." };

      const selectedIndices = Array.from(selectedColumns.keys()).sort((a,b) => a - b);

      const barcodeColIndex = findBarcodeColumnIndex(selectedIndices);
      if (barcodeColIndex === -1) {
        return { ok: false, error: "–ù–µ –Ω–∞–π–¥–µ–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞ —à—Ç—Ä–∏—Ö–∫–æ–¥–∞ —Å—Ä–µ–¥–∏ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö (–Ω–∞–∑–≤–∞–Ω–∏–µ –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å ¬´—à—Ç—Ä–∏—Ö–∫–æ–¥¬ª/barcode/ean)." };
      }

      // BOM –¥–ª—è Excel + UTF-8
      let csvContent = "\uFEFF";

      // Header row
      csvContent += selectedIndices.map(i => escapeCSV(selectedColumns.get(i) || "")).join(",") + "\n";

      const skipped = [];

      for (let rowIndex = startRowIndex; rowIndex < tableData.length; rowIndex++) {
        const row = tableData[rowIndex] || [];

        const rawBarcode = row[barcodeColIndex];
        const rawBarcodeStr = (rawBarcode === undefined || rawBarcode === null) ? "" : String(rawBarcode);

        const normalizedBarcode = normalizeBarcode(rawBarcode);

        if (!normalizedBarcode || !/^\d+$/.test(normalizedBarcode)) {
          const isEmpty = !rawBarcodeStr.trim();
          skipped.push({
            rowIndex,
            rowNumber: rowIndex + 1, // –∫–∞–∫ –≤ Excel
            rawBarcode: rawBarcodeStr,
            normalizedBarcode: normalizedBarcode || "",
            reason: isEmpty ? "–ü—É—Å—Ç–æ–π —à—Ç—Ä–∏—Ö–∫–æ–¥" : "–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —à—Ç—Ä–∏—Ö–∫–æ–¥"
          });
          continue;
        }

        const values = selectedIndices.map(colIndex => {
          if (colIndex === barcodeColIndex) return normalizedBarcode;

          let value = (row[colIndex] !== undefined && row[colIndex] !== null) ? row[colIndex] : "";
          value = String(value).trim();

          // "1349,00" -> "1349.00"
          if (/^\d+,\d{2}$/.test(value)) value = value.replace(",", ".");

          return value;
        });

        // –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ (–ø–æ—Å–ª–µ —Å—Ç–∞—Ä—Ç–∞)
        if (values.every(v => !String(v).trim())) continue;

        csvContent += values.map(v => escapeCSV(v)).join(",") + "\n";
      }

      return { ok: true, csvContent, skipped, skippedCount: skipped.length };
    }

    // --- Saving helpers ---
    function downloadTextFile(filename, text, mime) {
      const blob = new Blob([text], { type: mime || "text/plain;charset=utf-8" });
      const link = document.createElement("a");
      const url = URL.createObjectURL(blob);
      link.href = url;
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }

    async function saveTextFile(filename, text, mime) {
      if ("showSaveFilePicker" in window) {
        try {
          const handle = await window.showSaveFilePicker({
            suggestedName: filename,
            types: [{ description: "CSV", accept: { "text/csv": [".csv"] } }]
          });
          const writable = await handle.createWritable();
          await writable.write(new Blob([text], { type: mime || "text/plain;charset=utf-8" }));
          await writable.close();
          return true;
        } catch (e) {
          // Cancel / not allowed ‚Äî –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
          return false;
        }
      }

      // fallback ‚Äî –æ–±—ã—á–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞
      downloadTextFile(filename, text, mime);
      return true;
    }

    // --- Skipped modal ---
    function openSkippedModal(skipped, fileName) {
      pendingSkippedRows = skipped.slice();
      pendingCsvFileName = fileName || (originalFileName + ".csv");

      // NEW: –≤ –ø—Ä–µ–≤—å—é-–æ–∫–Ω–µ –ù–ï –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç—Ä–æ–∫–∏ —Å –ø—Ä–∏—á–∏–Ω–æ–π "–ü—É—Å—Ç–æ–π —à—Ç—Ä–∏—Ö–∫–æ–¥"
      const filteredForPreview = skipped.filter(s => s.reason !== "–ü—É—Å—Ç–æ–π —à—Ç—Ä–∏—Ö–∫–æ–¥");

      const hiddenCount = skipped.length - filteredForPreview.length;
      const maxShow = 500;
      const toShow = filteredForPreview.slice(0, maxShow);

      skippedSummary.textContent =
        `–í—Å–µ–≥–æ –ø—Ä–æ–ø—É—Å–∫–æ–≤: ${skipped.length}. –°–∫—Ä—ã—Ç–æ –ø—É—Å—Ç—ã—Ö: ${hiddenCount}. –ü–æ–∫–∞–∑–∞–Ω–æ: ${toShow.length}` +
        (filteredForPreview.length > maxShow ? ` (–∏–∑ ${filteredForPreview.length})` : "") + ".";

      let html = "<thead><tr>" +
        '<th style="min-width:90px;">–°—Ç—Ä–æ–∫–∞</th>' +
        '<th style="min-width:240px;">–®—Ç—Ä–∏—Ö–∫–æ–¥ (–∫–∞–∫ –≤ —Ñ–∞–π–ª–µ)</th>' +
        '<th style="min-width:240px;">–ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π</th>' +
        '<th style="min-width:260px;">–ü—Ä–∏—á–∏–Ω–∞</th>' +
        "</tr></thead><tbody>";

      toShow.forEach(s => {
        html += "<tr>" +
          `<td>${escapeHtml(s.rowNumber)}</td>` +
          `<td>${escapeHtml(s.rawBarcode)}</td>` +
          `<td>${escapeHtml(s.normalizedBarcode)}</td>` +
          `<td>${escapeHtml(s.reason)}</td>` +
          "</tr>";
      });

      html += "</tbody>";
      skippedTable.innerHTML = html;

      skippedModal.style.display = "flex";
    }

    function hideSkippedModal() { skippedModal.style.display = "none"; }

    closeSkippedModal.addEventListener("click", hideSkippedModal);
    skippedModal.addEventListener("click", function(e) {
      if (e.target === skippedModal) hideSkippedModal();
    });

    confirmDownloadCsvBtn.addEventListener("click", async function() {
      if (!pendingCsvContent) return;
      await saveTextFile(pendingCsvFileName || (originalFileName + ".csv"), pendingCsvContent, "text/csv;charset=utf-8");
      hideSkippedModal();
    });

    downloadSkippedBtn.addEventListener("click", async function() {
      if (!pendingSkippedRows || pendingSkippedRows.length === 0) {
        alert("–ù–µ—Ç –ø—Ä–æ–ø—É—Å–∫–æ–≤.");
        return;
      }

      let content = "rowNumber,rawBarcode,normalizedBarcode,reason\n";
      pendingSkippedRows.forEach(s => {
        const row = [s.rowNumber, s.rawBarcode, s.normalizedBarcode, s.reason].map(escapeCSV).join(",");
        content += row + "\n";
      });

      await saveTextFile(originalFileName + "_skipped-rows.csv", content, "text/csv;charset=utf-8");
    });

    // --- Main actions ---
    downloadBtn.addEventListener("click", async function() {
      const res = buildCsvAndSkipped();
      if (!res.ok) { alert(res.error); return; }

      pendingCsvContent = res.csvContent;

      // NEW: –º–æ–¥–∞–ª–∫—É –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–æ–ø—É—Å–∫–∏ –ù–ï –∏–∑-–∑–∞ –ø—É—Å—Ç–æ–≥–æ —à—Ç—Ä–∏—Ö–∫–æ–¥–∞
      const skippedForPreview = res.skipped.filter(s => s.reason !== "–ü—É—Å—Ç–æ–π —à—Ç—Ä–∏—Ö–∫–æ–¥");
      if (skippedForPreview.length > 0) {
        openSkippedModal(res.skipped, originalFileName + ".csv");
        return;
      }

      await saveTextFile(originalFileName + ".csv", res.csvContent, "text/csv;charset=utf-8");
    });

    resetBtn.addEventListener("click", function() {
      selectedColumns.clear();
      startRowIndex = 0;
      renderTable();
    });

    // --- Templates modal ---
    function renderTemplatesList() {
      templatesList.innerHTML = "";
      columnTemplates.forEach((t, idx) => {
        const row = document.createElement("div");
        row.className = "template-row";

        const input = document.createElement("input");
        input.type = "text";
        input.value = t;

        input.addEventListener("input", function() {
          columnTemplates[idx] = input.value;
          persistColumnTemplates();
          renderTable();
        });

        const delBtn = document.createElement("button");
        delBtn.className = "btn-secondary";
        delBtn.textContent = "–£–¥–∞–ª–∏—Ç—å";
        delBtn.addEventListener("click", function() {
          columnTemplates.splice(idx, 1);
          persistColumnTemplates();
          renderTemplatesList();
          renderTable();
        });

        row.appendChild(input);
        row.appendChild(delBtn);
        templatesList.appendChild(row);
      });
    }

    function openTemplatesModal() {
      renderTemplatesList();
      templatesModal.style.display = "flex";
      newTemplateInput.value = "";
      newTemplateInput.focus();
    }
    function hideTemplatesModal() { templatesModal.style.display = "none"; }

    manageTemplatesBtn.addEventListener("click", function(e) {
      e.stopPropagation();
      openTemplatesModal();
    });
    closeTemplatesModal.addEventListener("click", hideTemplatesModal);
    templatesModal.addEventListener("click", function(e) {
      if (e.target === templatesModal) hideTemplatesModal();
    });

    addTemplateBtn.addEventListener("click", function() {
      const val = newTemplateInput.value.trim();
      if (!val) return;
      columnTemplates.push(val);
      persistColumnTemplates();
      renderTemplatesList();
      renderTable();
      newTemplateInput.value = "";
      newTemplateInput.focus();
    });
    newTemplateInput.addEventListener("keydown", function(e) {
      if (e.key === "Enter") addTemplateBtn.click();
    });

    // --- Save app (export HTML without table data) ---
    function buildExportHtml() {
      persistColumnTemplates();

      const clone = document.documentElement.cloneNode(true);

      // remove table data
      const clonedTable = clone.querySelector("#dataTable");
      if (clonedTable) clonedTable.innerHTML = "";

      const uploadScreenClone = clone.querySelector("#uploadScreen");
      const tableContainerClone = clone.querySelector("#tableContainer");
      if (uploadScreenClone) uploadScreenClone.style.display = "flex";
      if (tableContainerClone) tableContainerClone.style.display = "none";

      const dl = clone.querySelector("#downloadBtn");
      if (dl) dl.disabled = true;

      const loadMoreContainerClone = clone.querySelector("#loadMoreContainer");
      if (loadMoreContainerClone) loadMoreContainerClone.style.display = "none";

      ["totalColumns", "selectedColumns", "totalRows", "remainingRows"].forEach(id => {
        const el = clone.querySelector("#" + id);
        if (el) el.textContent = "0";
      });

      clone.querySelectorAll(".dropdown.show").forEach(d => d.classList.remove("show"));

      const modal1 = clone.querySelector("#templatesModal");
      if (modal1) modal1.style.display = "none";
      const modal2 = clone.querySelector("#skippedModal");
      if (modal2) modal2.style.display = "none";

      return "<!DOCTYPE html>\n" + clone.outerHTML;
    }

    saveAppBtn.addEventListener("click", async function() {
      const html = buildExportHtml();
      await saveTextFile("table-to-csv-appsaved.html", html, "text/html;charset=utf-8");
    });
  </script>


</body></html>
